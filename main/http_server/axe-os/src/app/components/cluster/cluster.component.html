<ng-container *ngIf="clusterStatus$ | async as status; else loadingTemplate">
    <!-- Cluster Status Card -->
    <div class="card mb-4">
        <div class="flex justify-content-between align-items-center mb-4">
            <h2 class="m-0">Cluster Status</h2>
            <div class="flex align-items-center gap-2">
                <span class="text-500">Mode:</span>
                <p-dropdown
                    [options]="modeOptions"
                    [(ngModel)]="selectedMode"
                    optionLabel="label"
                    optionValue="value"
                    (onChange)="onModeChange($event)"
                    styleClass="w-8rem">
                </p-dropdown>
            </div>
        </div>

        <!-- Disabled Mode -->
        <ng-container *ngIf="status.mode === 0">
            <div class="text-center py-5">
                <i class="pi pi-ban text-4xl text-500 mb-3"></i>
                <p class="text-500 text-lg">Cluster mode is disabled</p>
                <p class="text-400 text-sm">Select Master or Slave mode to enable clustering</p>
            </div>
        </ng-container>

        <!-- Master Mode -->
        <ng-container *ngIf="status.mode === 1">
            <div class="grid">
                <!-- Summary Stats -->
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3 text-center">
                        <div class="text-500 mb-2">Active Slaves</div>
                        <div class="text-3xl font-bold text-primary">{{status.activeSlaves}}</div>
                    </div>
                </div>
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3 text-center">
                        <div class="text-500 mb-2">Cluster Hashrate</div>
                        <div class="text-3xl font-bold text-green-500">{{formatHashrate(status.totalHashrate || 0)}}</div>
                    </div>
                </div>
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3 text-center">
                        <div class="text-500 mb-2">Shares Accepted</div>
                        <div class="text-3xl font-bold text-green-500">{{status.totalSharesAccepted || 0}}</div>
                    </div>
                </div>
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3 text-center">
                        <div class="text-500 mb-2">Shares Rejected</div>
                        <div class="text-3xl font-bold" [ngClass]="{'text-red-500': (status.totalSharesRejected || 0) > 0, 'text-green-500': (status.totalSharesRejected || 0) === 0}">
                            {{status.totalSharesRejected || 0}}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transport Info -->
            <div class="surface-card border-round p-3 mb-4" *ngIf="status.transport">
                <div class="flex align-items-center gap-3">
                    <div class="flex align-items-center gap-2">
                        <i class="pi {{getTransportIcon(status.transport.type)}} text-primary"></i>
                        <span class="font-medium">{{getTransportLabel(status.transport.type)}}</span>
                    </div>
                    <span class="text-400">|</span>
                    <span class="text-500" *ngIf="status.transport.channel">Channel: {{status.transport.channel}}</span>
                    <span *ngIf="status.transport.encrypted" class="text-green-500">
                        <i class="pi pi-lock mr-1"></i>Encrypted
                    </span>
                    <span *ngIf="status.transport.discoveryActive" class="text-blue-500">
                        <i class="pi pi-search mr-1"></i>Discovery Active
                    </span>
                    <span class="text-500" *ngIf="status.transport.peerCount !== undefined">
                        Peers: {{status.transport.peerCount}}
                    </span>
                </div>
            </div>

            <!-- Autotune Section -->
            <div class="autotune-section surface-card border-round p-4 mb-4">
                <div class="flex justify-content-between align-items-center mb-3">
                    <div class="flex align-items-center gap-3">
                        <i class="pi pi-sliders-v text-2xl text-primary"></i>
                        <div>
                            <h3 class="m-0">Auto-Tuning</h3>
                            <span class="text-500 text-sm">Optimize frequency and voltage for efficiency</span>
                        </div>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="text-500 text-sm mr-2">{{autotuneEnabled ? 'Enabled' : 'Disabled'}}</span>
                        <p-inputSwitch [(ngModel)]="autotuneEnabled"
                                       (onChange)="toggleAutotune()"
                                       [disabled]="autotuneLoading">
                        </p-inputSwitch>
                    </div>
                </div>

                <!-- Autotune Status Display -->
                <ng-container *ngIf="autotuneStatus">
                    <div class="grid">
                        <!-- Oscilloscope Display -->
                        <div class="col-12 md:col-6">
                            <div class="oscilloscope-container" [class.active]="autotuneStatus.running">
                                <div class="oscilloscope-header">
                                    <span class="oscilloscope-title">SIGNAL ANALYSIS</span>
                                    <span class="oscilloscope-status" [ngClass]="getAutotuneStateClass(autotuneStatus.stateCode)">
                                        {{getAutotuneStateLabel(autotuneStatus.stateCode)}}
                                    </span>
                                </div>
                                <div class="oscilloscope-screen">
                                    <svg viewBox="0 0 200 100" class="oscilloscope-wave">
                                        <!-- Grid lines -->
                                        <line x1="0" y1="50" x2="200" y2="50" class="grid-line"/>
                                        <line x1="100" y1="0" x2="100" y2="100" class="grid-line"/>
                                        <!-- Wave path -->
                                        <path [attr.d]="getOscilloscopePath()" class="wave-path" [class.animated]="autotuneStatus.running"/>
                                    </svg>
                                    <!-- Scan line effect -->
                                    <div class="scanline" *ngIf="autotuneStatus.running"></div>
                                </div>
                                <div class="oscilloscope-footer">
                                    <span>FREQ: {{autotuneStatus.currentFrequency}} MHz</span>
                                    <span>VOLT: {{autotuneStatus.currentVoltage}} mV</span>
                                </div>
                            </div>
                        </div>

                        <!-- Current Values and Progress -->
                        <div class="col-12 md:col-6">
                            <div class="flex flex-column gap-3">
                                <!-- Progress Bar -->
                                <div *ngIf="autotuneStatus.running">
                                    <div class="flex justify-content-between mb-1">
                                        <span class="text-500">Progress</span>
                                        <span class="font-medium">{{autotuneStatus.progress}}%</span>
                                    </div>
                                    <p-progressBar [value]="autotuneStatus.progress" [showValue]="false" styleClass="h-1rem"></p-progressBar>
                                    <div class="flex justify-content-between mt-1 text-sm text-500">
                                        <span>Test {{autotuneStatus.testsCompleted}}/{{autotuneStatus.testsTotal}}</span>
                                        <span>{{formatDuration(autotuneStatus.totalDuration)}}</span>
                                    </div>
                                </div>

                                <!-- Best Found Values -->
                                <div class="surface-ground border-round p-3" *ngIf="autotuneStatus.bestFrequency > 0">
                                    <div class="text-500 text-sm mb-2">Best Settings Found</div>
                                    <div class="grid">
                                        <div class="col-6">
                                            <div class="text-sm text-500">Frequency</div>
                                            <div class="text-xl font-bold text-green-500">{{autotuneStatus.bestFrequency}} MHz</div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-sm text-500">Voltage</div>
                                            <div class="text-xl font-bold text-green-500">{{autotuneStatus.bestVoltage}} mV</div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-sm text-500">Efficiency</div>
                                            <div class="text-lg font-medium">{{autotuneStatus.bestEfficiency | number:'1.2-2'}} J/TH</div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-sm text-500">Hashrate</div>
                                            <div class="text-lg font-medium">{{autotuneStatus.bestHashrate | number:'1.2-2'}} GH/s</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Current Test Values -->
                                <div class="flex gap-3" *ngIf="autotuneStatus.running">
                                    <div class="flex-1 surface-ground border-round p-2 text-center">
                                        <div class="text-xs text-500">Testing</div>
                                        <div class="font-bold">{{autotuneStatus.currentFrequency}} MHz</div>
                                    </div>
                                    <div class="flex-1 surface-ground border-round p-2 text-center">
                                        <div class="text-xs text-500">At</div>
                                        <div class="font-bold">{{autotuneStatus.currentVoltage}} mV</div>
                                    </div>
                                </div>

                                <!-- Mode Display -->
                                <div class="flex align-items-center gap-2">
                                    <span class="text-500">Mode:</span>
                                    <span class="font-medium capitalize">{{autotuneStatus.mode}}</span>
                                </div>

                                <!-- Error Display -->
                                <div class="text-red-500" *ngIf="autotuneStatus.error">
                                    <i class="pi pi-exclamation-circle mr-2"></i>
                                    {{autotuneStatus.error}}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-content-end gap-2 mt-3 pt-3 border-top-1 surface-border">
                        <ng-container *ngIf="!autotuneStatus.running">
                            <button pButton label="Start Autotune" icon="pi pi-play"
                                    class="p-button-primary"
                                    (click)="openAutotuneDialog()"
                                    [disabled]="!autotuneEnabled || autotuneLoading"
                                    [loading]="autotuneLoading">
                            </button>
                        </ng-container>
                        <ng-container *ngIf="autotuneStatus.running">
                            <button pButton label="Stop & Revert" icon="pi pi-times"
                                    class="p-button-outlined p-button-secondary"
                                    (click)="stopAutotune(false)"
                                    [loading]="autotuneLoading">
                            </button>
                            <button pButton label="Stop & Apply Best" icon="pi pi-check"
                                    class="p-button-success"
                                    (click)="stopAutotune(true)"
                                    [loading]="autotuneLoading">
                            </button>
                        </ng-container>
                    </div>
                </ng-container>

                <!-- Initial State (no autotune data yet) -->
                <ng-container *ngIf="!autotuneStatus">
                    <div class="text-center py-4">
                        <i class="pi pi-spin pi-spinner text-2xl text-500 mb-2" *ngIf="autotuneLoading"></i>
                        <p class="text-500 m-0" *ngIf="!autotuneLoading">Enable autotune to optimize ASIC settings</p>
                    </div>
                </ng-container>
            </div>

            <!-- Bulk Actions Toolbar -->
            <div class="flex justify-content-between align-items-center mb-3" *ngIf="status.slaves && status.slaves.length > 0">
                <h3 class="m-0">Connected Slaves</h3>
                <div class="flex gap-2">
                    <button pButton label="Set All Freq" icon="pi pi-bolt" class="p-button-sm p-button-outlined"
                            (click)="openBulkAction('frequency')" pTooltip="Set frequency on all slaves"></button>
                    <button pButton label="Set All Voltage" icon="pi pi-sliders-h" class="p-button-sm p-button-outlined"
                            (click)="openBulkAction('voltage')" pTooltip="Set voltage on all slaves"></button>
                    <button pButton label="Set All Fan" icon="pi pi-sync" class="p-button-sm p-button-outlined"
                            (click)="openBulkAction('fan')" pTooltip="Set fan speed on all slaves"></button>
                    <button pButton label="Restart All" icon="pi pi-refresh" class="p-button-sm p-button-danger p-button-outlined"
                            (click)="openBulkAction('restart')" pTooltip="Restart all slaves"></button>
                </div>
            </div>

            <!-- Slave List -->
            <ng-container *ngIf="status.slaves && status.slaves.length > 0; else noSlaves">
                <div class="slave-list">
                    <ng-container *ngFor="let slave of status.slaves">
                        <!-- Slave Summary Row -->
                        <div class="surface-card border-round p-3 mb-2 cursor-pointer"
                             [ngClass]="{'border-primary border-1': expandedSlaveId === slave.slaveId}"
                             (click)="toggleSlaveConfig(slave)">
                            <div class="flex align-items-center justify-content-between">
                                <div class="flex align-items-center gap-3">
                                    <!-- Status Icon -->
                                    <i class="pi {{getSlaveStateIcon(slave.state)}} text-xl"
                                       [ngClass]="clusterService.getSlaveStateClass(slave.state)"></i>

                                    <!-- Device Info -->
                                    <div class="flex flex-column">
                                        <div class="flex align-items-center gap-2">
                                            <span class="font-bold">{{slave.hostname}}</span>
                                            <span class="text-500 text-sm">(ID: {{slave.slaveId}})</span>
                                            <!-- RSSI badge for ESP-NOW -->
                                            <span *ngIf="slave.rssi !== undefined"
                                                  class="text-sm px-2 py-1 border-round"
                                                  [ngClass]="clusterService.getRssiClass(slave.rssi)">
                                                <i class="pi pi-wifi mr-1"></i>{{clusterService.getRssiLabel(slave.rssi)}}
                                            </span>
                                        </div>
                                        <div class="flex align-items-center gap-2 text-sm">
                                            <a *ngIf="slave.ipAddr"
                                               [href]="'http://' + slave.ipAddr"
                                               target="_blank"
                                               class="text-primary"
                                               (click)="$event.stopPropagation()"
                                               pTooltip="Open slave web interface">
                                                <i class="pi pi-external-link mr-1" style="font-size: 0.7rem"></i>
                                                {{slave.ipAddr}}
                                            </a>
                                            <span *ngIf="!slave.ipAddr" class="text-400">No IP (ESP-NOW only)</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Stats -->
                                <div class="flex align-items-center gap-4">
                                    <div class="text-center">
                                        <div class="text-500 text-xs">Hashrate</div>
                                        <div class="font-bold text-green-500">{{formatHashrate(slave.hashrate)}}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-500 text-xs">Temp</div>
                                        <div class="font-bold">{{slave.temperature | number:'1.1-1'}}&deg;C</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-500 text-xs">Power</div>
                                        <div class="font-bold">{{slave.power | number:'1.1-1'}}W</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-500 text-xs">Shares</div>
                                        <div>
                                            <span class="text-green-500 font-bold">{{slave.sharesAccepted}}</span>
                                            <span class="text-400">/</span>
                                            <span class="text-red-500">{{slave.sharesSubmitted - slave.sharesAccepted}}</span>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-500 text-xs">Last Seen</div>
                                        <div class="text-sm">{{formatLastSeen(slave.lastSeen)}}</div>
                                    </div>
                                    <!-- Expand Icon -->
                                    <i class="pi text-xl text-500"
                                       [ngClass]="expandedSlaveId === slave.slaveId ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Expanded Configuration Panel -->
                        <div class="surface-card border-round p-4 mb-3 ml-4 border-left-3 border-primary"
                             *ngIf="expandedSlaveId === slave.slaveId"
                             @fadeInOut>
                            <ng-container *ngIf="loadingSlaveConfig === slave.slaveId; else configPanel">
                                <div class="flex justify-content-center py-4">
                                    <i class="pi pi-spin pi-spinner text-2xl"></i>
                                </div>
                            </ng-container>

                            <ng-template #configPanel>
                                <div class="grid">
                                    <!-- Device Info Column -->
                                    <div class="col-12 md:col-4">
                                        <h4 class="mt-0 mb-3">Device Info</h4>
                                        <div class="flex flex-column gap-2" *ngIf="getSlaveConfig(slave.slaveId) as config">
                                            <div class="flex justify-content-between">
                                                <span class="text-500">Model:</span>
                                                <span>{{config.deviceModel}}</span>
                                            </div>
                                            <div class="flex justify-content-between">
                                                <span class="text-500">Firmware:</span>
                                                <span>{{config.fwVersion}}</span>
                                            </div>
                                            <div class="flex justify-content-between">
                                                <span class="text-500">Uptime:</span>
                                                <span>{{config.uptime | number:'1.0-0'}}s</span>
                                            </div>
                                            <div class="flex justify-content-between">
                                                <span class="text-500">Free Heap:</span>
                                                <span>{{config.freeHeap | number:'1.0-0'}} bytes</span>
                                            </div>
                                            <div class="flex justify-content-between">
                                                <span class="text-500">Efficiency:</span>
                                                <span>{{config.efficiency | number:'1.1-1'}} J/TH</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Mining Settings Column -->
                                    <div class="col-12 md:col-4">
                                        <h4 class="mt-0 mb-3">Mining Settings</h4>
                                        <div class="flex flex-column gap-3">
                                            <!-- Frequency -->
                                            <div class="flex align-items-center gap-2">
                                                <label class="w-6rem text-500">Frequency:</label>
                                                <p-inputNumber [(ngModel)]="editFrequency"
                                                               [min]="200" [max]="800"
                                                               suffix=" MHz"
                                                               styleClass="w-8rem p-inputtext-sm">
                                                </p-inputNumber>
                                                <button pButton icon="pi pi-check" class="p-button-sm p-button-success"
                                                        (click)="saveSlaveFrequency(slave.slaveId); $event.stopPropagation()"
                                                        [loading]="savingSlaveConfig === slave.slaveId"
                                                        pTooltip="Apply frequency"></button>
                                            </div>
                                            <!-- Voltage -->
                                            <div class="flex align-items-center gap-2">
                                                <label class="w-6rem text-500">Voltage:</label>
                                                <p-inputNumber [(ngModel)]="editVoltage"
                                                               [min]="1000" [max]="1400"
                                                               suffix=" mV"
                                                               styleClass="w-8rem p-inputtext-sm">
                                                </p-inputNumber>
                                                <button pButton icon="pi pi-check" class="p-button-sm p-button-success"
                                                        (click)="saveSlaveVoltage(slave.slaveId); $event.stopPropagation()"
                                                        [loading]="savingSlaveConfig === slave.slaveId"
                                                        pTooltip="Apply voltage"></button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cooling Settings Column -->
                                    <div class="col-12 md:col-4">
                                        <h4 class="mt-0 mb-3">Cooling Settings</h4>
                                        <div class="flex flex-column gap-3">
                                            <!-- Fan Mode -->
                                            <div class="flex align-items-center gap-2">
                                                <label class="w-6rem text-500">Fan Mode:</label>
                                                <p-dropdown [options]="fanModeOptions"
                                                            [(ngModel)]="editFanMode"
                                                            optionLabel="label"
                                                            optionValue="value"
                                                            styleClass="w-8rem"
                                                            (onChange)="saveSlaveFanMode(slave.slaveId)"
                                                            (click)="$event.stopPropagation()">
                                                </p-dropdown>
                                            </div>
                                            <!-- Fan Speed (only if manual) -->
                                            <div class="flex align-items-center gap-2" *ngIf="editFanMode === 1">
                                                <label class="w-6rem text-500">Fan Speed:</label>
                                                <p-inputNumber [(ngModel)]="editFanSpeed"
                                                               [min]="0" [max]="100"
                                                               suffix="%"
                                                               styleClass="w-8rem p-inputtext-sm">
                                                </p-inputNumber>
                                                <button pButton icon="pi pi-check" class="p-button-sm p-button-success"
                                                        (click)="saveSlaveFanSpeed(slave.slaveId); $event.stopPropagation()"
                                                        [loading]="savingSlaveConfig === slave.slaveId"
                                                        pTooltip="Apply fan speed"></button>
                                            </div>
                                            <!-- Target Temp (only if auto) -->
                                            <div class="flex align-items-center gap-2" *ngIf="editFanMode === 0">
                                                <label class="w-6rem text-500">Target Temp:</label>
                                                <p-inputNumber [(ngModel)]="editTargetTemp"
                                                               [min]="40" [max]="75"
                                                               suffix="&deg;C"
                                                               styleClass="w-8rem p-inputtext-sm">
                                                </p-inputNumber>
                                                <button pButton icon="pi pi-check" class="p-button-sm p-button-success"
                                                        (click)="saveSlaveTargetTemp(slave.slaveId); $event.stopPropagation()"
                                                        [loading]="savingSlaveConfig === slave.slaveId"
                                                        pTooltip="Apply target temp"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex justify-content-end gap-2 mt-3 pt-3 border-top-1 surface-border">
                                    <button pButton label="Identify" icon="pi pi-lightbulb" class="p-button-sm p-button-outlined"
                                            (click)="identifySlave(slave.slaveId); $event.stopPropagation()"
                                            pTooltip="Flash LED to identify device"></button>
                                    <button pButton label="Restart" icon="pi pi-refresh" class="p-button-sm p-button-danger p-button-outlined"
                                            (click)="restartSlave(slave.slaveId); $event.stopPropagation()"
                                            pTooltip="Restart this slave"></button>
                                </div>
                            </ng-template>
                        </div>
                    </ng-container>
                </div>
                <!-- Cluster Power Summary -->
                <div class="mt-3 surface-card border-round p-3" *ngIf="status.slaves && status.slaves.length > 0">
                    <div class="flex justify-content-between align-items-center">
                        <span class="text-500">Total Cluster Power:</span>
                        <span class="font-bold text-lg">{{getTotalPower(status.slaves) | number:'1.1-1'}} W</span>
                    </div>
                </div>
            </ng-container>
            <ng-template #noSlaves>
                <div class="text-center py-4 surface-card border-round">
                    <i class="pi pi-users text-3xl text-500 mb-2"></i>
                    <p class="text-500 m-0">No slaves connected</p>
                    <p class="text-400 text-sm mt-1">Waiting for slave devices to register...</p>
                </div>
            </ng-template>

            <!-- API Access Info -->
            <div class="mt-4 p-3 surface-card border-round">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-info-circle text-blue-500"></i>
                    <span class="font-medium">External API Access</span>
                </div>
                <p class="text-500 text-sm m-0 mb-2">
                    Both master and slave devices expose their full API. Click on a slave's IP to access its web interface directly.
                </p>
                <div class="flex flex-wrap gap-2">
                    <span class="text-400 text-sm">Master API: <code>/api/cluster/status</code></span>
                    <span class="text-400 text-sm">Slave API: <code>http://[slave-ip]/api/system/info</code></span>
                </div>
            </div>
        </ng-container>

        <!-- Slave Mode -->
        <ng-container *ngIf="status.mode === 2">
            <div class="grid">
                <div class="col-12 md:col-6">
                    <div class="surface-card shadow-1 border-round p-4">
                        <h4 class="mt-0 mb-3">Connection Status</h4>
                        <div class="flex align-items-center gap-2 mb-3">
                            <i class="pi" [ngClass]="{
                                'pi-check-circle text-green-500': status.connectedToMaster,
                                'pi-times-circle text-red-500': !status.connectedToMaster
                            }"></i>
                            <span [ngClass]="{
                                'text-green-500': status.connectedToMaster,
                                'text-red-500': !status.connectedToMaster
                            }">
                                {{status.connectedToMaster ? 'Connected to Master' : 'Disconnected'}}
                            </span>
                        </div>
                        <div class="flex flex-column gap-2">
                            <div class="flex justify-content-between">
                                <span class="text-500">Hostname:</span>
                                <span>{{status.hostname}}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 md:col-6">
                    <div class="surface-card shadow-1 border-round p-4">
                        <h4 class="mt-0 mb-3">Local Stats</h4>
                        <div class="flex flex-column gap-2">
                            <div class="flex justify-content-between">
                                <span class="text-500">Hashrate:</span>
                                <span class="text-green-500 font-medium">{{formatHashrate(status.localHashrate || 0)}}</span>
                            </div>
                            <div class="flex justify-content-between">
                                <span class="text-500">Temperature:</span>
                                <span>{{status.localTemperature | number:'1.1-1'}} &deg;C</span>
                            </div>
                            <div class="flex justify-content-between">
                                <span class="text-500">Fan RPM:</span>
                                <span>{{status.localFanRpm}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 p-3 surface-card border-round">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-info-circle text-blue-500"></i>
                    <span class="text-500">
                        In slave mode, this device receives mining work from the master and reports shares back.
                        Pool connection is handled by the master device.
                    </span>
                </div>
            </div>
        </ng-container>
    </div>
</ng-container>

<ng-template #loadingTemplate>
    <div class="card">
        <div class="flex justify-content-center align-items-center py-5">
            <i class="pi pi-spin pi-spinner text-4xl"></i>
        </div>
    </div>
</ng-template>

<!-- Mode Change Confirmation Dialog -->
<p-dialog
    header="Change Cluster Mode"
    [(visible)]="showModeChangeDialog"
    [modal]="true"
    [style]="{width: '400px'}">
    <p>Changing cluster mode requires a device restart. Are you sure you want to continue?</p>
    <p class="text-orange-500 font-medium mt-2">
        <i class="pi pi-exclamation-triangle mr-2"></i>
        Mining will be interrupted during restart.
    </p>
    <ng-template pTemplate="footer">
        <button pButton label="Cancel" class="p-button-text" (click)="cancelModeChange()"></button>
        <button pButton label="Change & Restart" class="p-button-danger" (click)="confirmModeChange()"></button>
    </ng-template>
</p-dialog>

<!-- Bulk Action Dialog -->
<p-dialog
    [header]="getBulkActionTitle()"
    [(visible)]="showBulkActionDialog"
    [modal]="true"
    [style]="{width: '400px'}">

    <!-- Frequency Input -->
    <div *ngIf="bulkActionType === 'frequency'" class="flex flex-column gap-3">
        <p class="text-500 mt-0">Set the same frequency on all connected slaves.</p>
        <div class="flex align-items-center gap-2">
            <label class="w-6rem">Frequency:</label>
            <p-inputNumber [(ngModel)]="bulkFrequency"
                           [min]="200" [max]="800"
                           suffix=" MHz"
                           styleClass="flex-1">
            </p-inputNumber>
        </div>
        <p class="text-orange-500 text-sm m-0">
            <i class="pi pi-exclamation-triangle mr-1"></i>
            Higher frequencies increase power consumption and heat.
        </p>
    </div>

    <!-- Voltage Input -->
    <div *ngIf="bulkActionType === 'voltage'" class="flex flex-column gap-3">
        <p class="text-500 mt-0">Set the same core voltage on all connected slaves.</p>
        <div class="flex align-items-center gap-2">
            <label class="w-6rem">Voltage:</label>
            <p-inputNumber [(ngModel)]="bulkVoltage"
                           [min]="1000" [max]="1400"
                           suffix=" mV"
                           styleClass="flex-1">
            </p-inputNumber>
        </div>
        <p class="text-orange-500 text-sm m-0">
            <i class="pi pi-exclamation-triangle mr-1"></i>
            Higher voltages may damage hardware. Use with caution.
        </p>
    </div>

    <!-- Fan Speed Input -->
    <div *ngIf="bulkActionType === 'fan'" class="flex flex-column gap-3">
        <p class="text-500 mt-0">Set the same fan speed percentage on all connected slaves.</p>
        <div class="flex align-items-center gap-2">
            <label class="w-6rem">Fan Speed:</label>
            <p-inputNumber [(ngModel)]="bulkFanSpeed"
                           [min]="0" [max]="100"
                           suffix="%"
                           styleClass="flex-1">
            </p-inputNumber>
        </div>
        <p class="text-500 text-sm m-0">
            <i class="pi pi-info-circle mr-1"></i>
            This sets fan mode to Manual on all slaves.
        </p>
    </div>

    <!-- Restart Confirmation -->
    <div *ngIf="bulkActionType === 'restart'" class="flex flex-column gap-3">
        <p class="text-500 mt-0">This will restart all connected slave devices.</p>
        <p class="text-orange-500 font-medium m-0">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            Mining will be interrupted on all slaves during restart.
        </p>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Cancel" class="p-button-text" (click)="cancelBulkAction()"></button>
        <button pButton
                [label]="bulkActionType === 'restart' ? 'Restart All' : 'Apply to All'"
                [class]="bulkActionType === 'restart' ? 'p-button-danger' : 'p-button-primary'"
                (click)="executeBulkAction()"></button>
    </ng-template>
</p-dialog>

<!-- Autotune Mode Selection Dialog -->
<p-dialog
    header="Start Auto-Tuning"
    [(visible)]="showAutotuneDialog"
    [modal]="true"
    [style]="{width: '450px'}">

    <div class="flex flex-column gap-4">
        <p class="text-500 mt-0">
            Auto-tuning will test different frequency and voltage combinations to find the optimal settings.
        </p>

        <div class="flex flex-column gap-2">
            <label class="font-medium">Optimization Mode</label>
            <p-dropdown [options]="autotuneModeOptions"
                        [(ngModel)]="selectedAutotuneMode"
                        optionLabel="label"
                        optionValue="value"
                        styleClass="w-full">
            </p-dropdown>
        </div>

        <div class="surface-ground border-round p-3">
            <div class="flex flex-column gap-2 text-sm">
                <div *ngIf="selectedAutotuneMode === 'efficiency'">
                    <i class="pi pi-bolt text-green-500 mr-2"></i>
                    <strong>Efficiency Mode:</strong> Finds the best J/TH ratio. Lower power consumption while maintaining hashrate.
                </div>
                <div *ngIf="selectedAutotuneMode === 'hashrate'">
                    <i class="pi pi-chart-line text-blue-500 mr-2"></i>
                    <strong>Hashrate Mode:</strong> Maximizes hashrate regardless of power consumption.
                </div>
                <div *ngIf="selectedAutotuneMode === 'balanced'">
                    <i class="pi pi-sliders-h text-orange-500 mr-2"></i>
                    <strong>Balanced Mode:</strong> Finds a middle ground between efficiency and hashrate.
                </div>
            </div>
        </div>

        <div class="text-orange-500 text-sm">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            Auto-tuning may take several minutes to complete. Mining will continue during this process.
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Cancel" class="p-button-text" (click)="showAutotuneDialog = false"></button>
        <button pButton label="Start" icon="pi pi-play" class="p-button-primary" (click)="startAutotune()"></button>
    </ng-template>
</p-dialog>

<!-- Toast for notifications -->
<p-toast></p-toast>
