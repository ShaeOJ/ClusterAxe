<ng-container *ngIf="clusterStatus$ | async as status; else loadingTemplate">
    <!-- Cluster Status Card -->
    <div class="card mb-4">
        <div class="flex justify-content-between align-items-center mb-4">
            <h2 class="m-0">Cluster Status</h2>
            <div class="flex align-items-center gap-2">
                <span class="text-500">Mode:</span>
                <p-dropdown
                    [options]="modeOptions"
                    [(ngModel)]="selectedMode"
                    optionLabel="label"
                    optionValue="value"
                    (onChange)="onModeChange($event)"
                    styleClass="w-8rem">
                </p-dropdown>
            </div>
        </div>

        <!-- Disabled Mode -->
        <ng-container *ngIf="status.mode === 0">
            <div class="text-center py-5">
                <i class="pi pi-ban text-4xl text-500 mb-3"></i>
                <p class="text-500 text-lg">Cluster mode is disabled</p>
                <p class="text-400 text-sm">Select Master or Slave mode to enable clustering</p>
            </div>
        </ng-container>

        <!-- Master Mode -->
        <ng-container *ngIf="status.mode === 1">
            <div class="grid">
                <!-- Summary Stats -->
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3 text-center">
                        <div class="text-500 mb-2">Active Slaves</div>
                        <div class="text-3xl font-bold text-primary">{{status.activeSlaves}}</div>
                    </div>
                </div>
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3 text-center">
                        <div class="text-500 mb-2">Cluster Hashrate</div>
                        <div class="text-3xl font-bold text-green-500">{{formatHashrate(status.totalHashrate || 0)}}</div>
                    </div>
                </div>
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3 text-center">
                        <div class="text-500 mb-2">Shares Accepted</div>
                        <div class="text-3xl font-bold text-green-500">{{status.totalSharesAccepted || 0}}</div>
                    </div>
                </div>
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3 text-center">
                        <div class="text-500 mb-2">Shares Rejected</div>
                        <div class="text-3xl font-bold" [ngClass]="{'text-red-500': (status.totalSharesRejected || 0) > 0, 'text-green-500': (status.totalSharesRejected || 0) === 0}">
                            {{status.totalSharesRejected || 0}}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slave List -->
            <h3 class="mt-4 mb-3">Connected Slaves</h3>
            <ng-container *ngIf="status.slaves && status.slaves.length > 0; else noSlaves">
                <p-table [value]="status.slaves" styleClass="p-datatable-sm" [scrollable]="true">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Status</th>
                            <th>Device</th>
                            <th>Hashrate</th>
                            <th>Temp</th>
                            <th>Fan</th>
                            <th>Freq</th>
                            <th>Voltage</th>
                            <th>Power</th>
                            <th>Shares</th>
                            <th>Last Seen</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-slave>
                        <tr>
                            <td>
                                <i class="pi {{getSlaveStateIcon(slave.state)}}"
                                   [ngClass]="clusterService.getSlaveStateClass(slave.state)"></i>
                                <span class="ml-2" [ngClass]="clusterService.getSlaveStateClass(slave.state)">
                                    {{clusterService.getSlaveStateLabel(slave.state)}}
                                </span>
                            </td>
                            <td>
                                <div class="flex flex-column">
                                    <span class="font-medium">{{slave.hostname}}</span>
                                    <a *ngIf="slave.ipAddr"
                                       [href]="'http://' + slave.ipAddr"
                                       target="_blank"
                                       class="text-primary text-sm"
                                       pTooltip="Open slave web interface"
                                       tooltipPosition="top">
                                        <i class="pi pi-external-link mr-1" style="font-size: 0.75rem"></i>
                                        {{slave.ipAddr}}
                                    </a>
                                    <span *ngIf="!slave.ipAddr" class="text-400 text-sm">No IP</span>
                                </div>
                            </td>
                            <td class="font-medium text-green-500">{{formatHashrate(slave.hashrate)}}</td>
                            <td>{{slave.temperature | number:'1.1-1'}} &deg;C</td>
                            <td>{{slave.fanRpm}} RPM</td>
                            <td>{{slave.frequency}} MHz</td>
                            <td>{{slave.coreVoltage}} mV</td>
                            <td>{{slave.power | number:'1.1-1'}} W</td>
                            <td>
                                <span class="text-green-500">{{slave.sharesAccepted}}</span>
                                <span class="text-500"> / </span>
                                <span class="text-red-500">{{slave.sharesSubmitted - slave.sharesAccepted}}</span>
                            </td>
                            <td>{{formatLastSeen(slave.lastSeen)}}</td>
                        </tr>
                    </ng-template>
                </p-table>
                <!-- Cluster Power Summary -->
                <div class="mt-3 surface-card border-round p-3" *ngIf="status.slaves && status.slaves.length > 0">
                    <div class="flex justify-content-between align-items-center">
                        <span class="text-500">Total Cluster Power:</span>
                        <span class="font-bold text-lg">{{getTotalPower(status.slaves) | number:'1.1-1'}} W</span>
                    </div>
                </div>
            </ng-container>
            <ng-template #noSlaves>
                <div class="text-center py-4 surface-card border-round">
                    <i class="pi pi-users text-3xl text-500 mb-2"></i>
                    <p class="text-500 m-0">No slaves connected</p>
                    <p class="text-400 text-sm mt-1">Waiting for slave devices to register...</p>
                </div>
            </ng-template>

            <!-- API Access Info -->
            <div class="mt-4 p-3 surface-card border-round">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-info-circle text-blue-500"></i>
                    <span class="font-medium">External API Access</span>
                </div>
                <p class="text-500 text-sm m-0 mb-2">
                    Both master and slave devices expose their full API. Click on a slave's IP to access its web interface directly.
                </p>
                <div class="flex flex-wrap gap-2">
                    <span class="text-400 text-sm">Master API: <code>/api/cluster/status</code></span>
                    <span class="text-400 text-sm">Slave API: <code>http://[slave-ip]/api/system/info</code></span>
                </div>
            </div>
        </ng-container>

        <!-- Slave Mode -->
        <ng-container *ngIf="status.mode === 2">
            <div class="grid">
                <div class="col-12 md:col-6">
                    <div class="surface-card shadow-1 border-round p-4">
                        <h4 class="mt-0 mb-3">Connection Status</h4>
                        <div class="flex align-items-center gap-2 mb-3">
                            <i class="pi" [ngClass]="{
                                'pi-check-circle text-green-500': status.connectedToMaster,
                                'pi-times-circle text-red-500': !status.connectedToMaster
                            }"></i>
                            <span [ngClass]="{
                                'text-green-500': status.connectedToMaster,
                                'text-red-500': !status.connectedToMaster
                            }">
                                {{status.connectedToMaster ? 'Connected to Master' : 'Disconnected'}}
                            </span>
                        </div>
                        <div class="flex flex-column gap-2">
                            <div class="flex justify-content-between">
                                <span class="text-500">Hostname:</span>
                                <span>{{status.hostname}}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 md:col-6">
                    <div class="surface-card shadow-1 border-round p-4">
                        <h4 class="mt-0 mb-3">Local Stats</h4>
                        <div class="flex flex-column gap-2">
                            <div class="flex justify-content-between">
                                <span class="text-500">Hashrate:</span>
                                <span class="text-green-500 font-medium">{{formatHashrate(status.localHashrate || 0)}}</span>
                            </div>
                            <div class="flex justify-content-between">
                                <span class="text-500">Temperature:</span>
                                <span>{{status.localTemperature | number:'1.1-1'}} &deg;C</span>
                            </div>
                            <div class="flex justify-content-between">
                                <span class="text-500">Fan RPM:</span>
                                <span>{{status.localFanRpm}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 p-3 surface-card border-round">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-info-circle text-blue-500"></i>
                    <span class="text-500">
                        In slave mode, this device receives mining work from the master and reports shares back.
                        Pool connection is handled by the master device.
                    </span>
                </div>
            </div>
        </ng-container>
    </div>
</ng-container>

<ng-template #loadingTemplate>
    <div class="card">
        <div class="flex justify-content-center align-items-center py-5">
            <i class="pi pi-spin pi-spinner text-4xl"></i>
        </div>
    </div>
</ng-template>

<!-- Mode Change Confirmation Dialog -->
<p-dialog
    header="Change Cluster Mode"
    [(visible)]="showModeChangeDialog"
    [modal]="true"
    [style]="{width: '400px'}">
    <p>Changing cluster mode requires a device restart. Are you sure you want to continue?</p>
    <p class="text-orange-500 font-medium mt-2">
        <i class="pi pi-exclamation-triangle mr-2"></i>
        Mining will be interrupted during restart.
    </p>
    <ng-template pTemplate="footer">
        <button pButton label="Cancel" class="p-button-text" (click)="cancelModeChange()"></button>
        <button pButton label="Change & Restart" class="p-button-danger" (click)="confirmModeChange()"></button>
    </ng-template>
</p-dialog>
