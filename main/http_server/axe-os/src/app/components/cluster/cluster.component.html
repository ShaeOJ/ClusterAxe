<ng-container *ngIf="clusterStatus$ | async as status; else loadingTemplate">
<div class="flex justify-content-center px-3">
<div class="w-full" style="max-width: 1400px;">
    <!-- Header with Mode -->
    <div class="flex justify-content-between align-items-center mb-3">
        <h2 class="m-0 text-xl">Cluster</h2>
        <p-dropdown
            [options]="modeOptions"
            [(ngModel)]="selectedMode"
            optionLabel="label"
            optionValue="value"
            (onChange)="onModeChange($event)"
            styleClass="w-7rem">
        </p-dropdown>
    </div>

    <!-- Disabled Mode -->
    <ng-container *ngIf="status.mode === 0">
        <div class="surface-card border-round text-center py-5">
            <i class="pi pi-ban text-4xl text-500 mb-3"></i>
            <p class="text-500">Cluster mode is disabled</p>
            <p class="text-400 text-sm">Select Master or Slave mode to enable</p>
        </div>
    </ng-container>

    <!-- Master Mode -->
    <ng-container *ngIf="status.mode === 1">
        <!-- Stats Row -->
        <div class="flex flex-wrap justify-content-center gap-2 mb-3">
            <div class="surface-card border-round p-2 px-3 text-center flex-grow-1" style="min-width: 120px;">
                <div class="text-400 text-xs mb-1">Slaves</div>
                <div class="text-xl font-bold text-primary">{{status.activeSlaves}}</div>
            </div>
            <div class="surface-card border-round p-2 px-3 text-center flex-grow-1" style="min-width: 140px;">
                <div class="text-400 text-xs mb-1">Hashrate</div>
                <div class="text-xl font-bold text-green-500">{{formatHashrate(status.totalHashrate || 0)}}</div>
            </div>
            <div class="surface-card border-round p-2 px-3 text-center flex-grow-1" style="min-width: 100px;">
                <div class="text-400 text-xs mb-1">Shares</div>
                <div class="text-xl font-bold">
                    <span class="text-green-500">{{status.totalSharesAccepted || 0}}</span>
                    <span class="text-red-500 text-sm" *ngIf="(status.totalSharesRejected || 0) > 0">/{{status.totalSharesRejected}}</span>
                </div>
            </div>
            <div class="surface-card border-round p-2 px-3 text-center flex-grow-1" style="min-width: 100px;" *ngIf="status.transport">
                <div class="text-400 text-xs mb-1">Transport</div>
                <div class="text-sm font-medium">
                    <i class="pi {{getTransportIcon(status.transport.type)}} mr-1 text-primary"></i>{{getTransportLabel(status.transport.type)}}
                </div>
            </div>
        </div>

        <!-- Master Device Card -->
        <div class="surface-card border-round p-3 mb-3 cursor-pointer hover:surface-hover transition-colors transition-duration-150"
             [ngClass]="{'border-primary border-2': masterExpanded, 'border-1 border-transparent': !masterExpanded}"
             (click)="toggleMasterExpanded()">
            <div class="grid align-items-center">
                <!-- Left: Icon + Name -->
                <div class="col-12 md:col-3 flex align-items-center gap-2">
                    <i class="pi pi-desktop text-lg text-primary"></i>
                    <div>
                        <div class="font-bold">Master Device</div>
                        <div class="text-xs text-400">This device</div>
                    </div>
                </div>

                <!-- Center: Stats -->
                <div class="col-12 md:col-7">
                    <div class="flex justify-content-center gap-3 md:gap-5 flex-wrap" *ngIf="masterInfo">
                        <!-- Hashrate -->
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-chart-line text-green-500"></i>
                            <div>
                                <div class="text-xs text-500">Hashrate</div>
                                <div class="font-bold text-green-500">{{formatHashrate(masterInfo.hashRate || 0)}}</div>
                            </div>
                        </div>
                        <!-- Temp -->
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-sun" [ngClass]="{'text-orange-500': masterInfo.temp > 60, 'text-red-500': masterInfo.temp > 70, 'text-blue-500': masterInfo.temp <= 60}"></i>
                            <div>
                                <div class="text-xs text-500">Temp</div>
                                <div class="font-bold" [ngClass]="{'text-orange-500': masterInfo.temp > 60, 'text-red-500': masterInfo.temp > 70}">{{masterInfo.temp | number:'1.0-0'}}°C</div>
                            </div>
                        </div>
                        <!-- Power -->
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-bolt text-yellow-500"></i>
                            <div>
                                <div class="text-xs text-500">Power</div>
                                <div class="font-bold">{{masterInfo.power | number:'1.1-1'}}W</div>
                            </div>
                        </div>
                        <!-- Freq -->
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-sliders-h text-cyan-500"></i>
                            <div>
                                <div class="text-xs text-500">Freq</div>
                                <div class="font-bold">{{masterInfo.frequency}} MHz</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Expand -->
                <div class="col-12 md:col-2 flex justify-content-end align-items-center gap-2">
                    <i class="pi text-lg text-500"
                       [ngClass]="masterExpanded ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
                </div>
            </div>
        </div>

        <!-- Expanded Master Configuration Panel -->
        <div class="surface-card border-round p-4 mb-3 border-left-3 border-primary"
             *ngIf="masterExpanded"
             @fadeInOut>
            <div class="grid">
                <!-- Device Info Column -->
                <div class="col-12 md:col-4">
                    <h4 class="mt-0 mb-3">Device Info</h4>
                    <div class="flex flex-column gap-2" *ngIf="masterInfo">
                        <div class="flex justify-content-between">
                            <span class="text-500">Model:</span>
                            <span>{{masterInfo.ASICModel}}</span>
                        </div>
                        <div class="flex justify-content-between">
                            <span class="text-500">Firmware:</span>
                            <span>{{masterInfo.version}}</span>
                        </div>
                        <div class="flex justify-content-between">
                            <span class="text-500">Hostname:</span>
                            <span>{{masterInfo.hostname}}</span>
                        </div>
                        <div class="flex justify-content-between">
                            <span class="text-500">Efficiency:</span>
                            <span>{{masterInfo.power && masterInfo.hashRate ? ((masterInfo.power / (masterInfo.hashRate / 1000)) | number:'1.1-1') : 'N/A'}} J/TH</span>
                        </div>
                    </div>
                </div>

                <!-- Mining Settings Column -->
                <div class="col-12 md:col-4">
                    <h4 class="mt-0 mb-3">Mining Settings</h4>
                    <div class="flex flex-column gap-3">
                        <!-- Frequency -->
                        <div class="flex align-items-center gap-2">
                            <label class="w-6rem text-500">Frequency:</label>
                            <p-inputNumber [(ngModel)]="masterFrequency"
                                           [min]="200" [max]="800"
                                           suffix=" MHz"
                                           styleClass="w-8rem p-inputtext-sm"
                                           (click)="$event.stopPropagation()">
                            </p-inputNumber>
                            <button pButton icon="pi pi-check" class="p-button-sm p-button-success"
                                    (click)="saveMasterFrequency(); $event.stopPropagation()"
                                    [loading]="savingMasterConfig"
                                    pTooltip="Apply frequency"></button>
                        </div>
                        <!-- Voltage -->
                        <div class="flex align-items-center gap-2">
                            <label class="w-6rem text-500">Voltage:</label>
                            <p-inputNumber [(ngModel)]="masterVoltage"
                                           [min]="1000" [max]="1300"
                                           suffix=" mV"
                                           styleClass="w-8rem p-inputtext-sm"
                                           (click)="$event.stopPropagation()">
                            </p-inputNumber>
                            <button pButton icon="pi pi-check" class="p-button-sm p-button-success"
                                    (click)="saveMasterVoltage(); $event.stopPropagation()"
                                    [loading]="savingMasterConfig"
                                    pTooltip="Apply voltage"></button>
                        </div>
                    </div>
                </div>

                <!-- Cooling Settings Column -->
                <div class="col-12 md:col-4">
                    <h4 class="mt-0 mb-3">Cooling Settings</h4>
                    <div class="flex flex-column gap-3">
                        <!-- Fan Mode -->
                        <div class="flex align-items-center gap-2">
                            <label class="w-6rem text-500">Fan Mode:</label>
                            <p-dropdown [options]="fanModeOptions"
                                        [(ngModel)]="masterFanMode"
                                        optionLabel="label"
                                        optionValue="value"
                                        styleClass="w-8rem"
                                        (onChange)="saveMasterFanMode()"
                                        (click)="$event.stopPropagation()">
                            </p-dropdown>
                        </div>
                        <!-- Fan Speed (only if manual) -->
                        <div class="flex align-items-center gap-2" *ngIf="masterFanMode === 1">
                            <label class="w-6rem text-500">Fan Speed:</label>
                            <p-inputNumber [(ngModel)]="masterFanSpeed"
                                           [min]="0" [max]="100"
                                           suffix="%"
                                           styleClass="w-8rem p-inputtext-sm"
                                           (click)="$event.stopPropagation()">
                            </p-inputNumber>
                            <button pButton icon="pi pi-check" class="p-button-sm p-button-success"
                                    (click)="saveMasterFanSpeed(); $event.stopPropagation()"
                                    [loading]="savingMasterConfig"
                                    pTooltip="Apply fan speed"></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Autotune Toggle for Master -->
            <div class="mt-3 pt-3 border-top-1 surface-border">
                <div class="flex align-items-center gap-3">
                    <p-checkbox [(ngModel)]="masterIncludeInAutotune"
                                [binary]="true"
                                inputId="masterAutotune"
                                (click)="$event.stopPropagation()">
                    </p-checkbox>
                    <label for="masterAutotune" class="cursor-pointer" (click)="$event.stopPropagation()">
                        Include master in cluster auto-tune
                    </label>
                </div>
            </div>
        </div>

        <!-- Auto-Tune (Compact) -->
        <div class="surface-card border-round p-3 mb-3">
                <div class="flex flex-column md:flex-row align-items-center gap-3">
                    <!-- Oscilloscope (compact) -->
                    <div class="oscilloscope-container flex-shrink-0" [class.active]="autotuneStatus?.running"
                         style="width: 200px; border-radius: 8px; overflow: hidden;">
                        <div class="oscilloscope-screen" style="height: 80px;">
                            <svg viewBox="0 0 200 100" class="oscilloscope-wave">
                                <line x1="0" y1="50" x2="200" y2="50" class="grid-line"/>
                                <line x1="100" y1="0" x2="100" y2="100" class="grid-line"/>
                                <path [attr.d]="getOscilloscopePath()" class="wave-path" [class.animated]="autotuneStatus?.running"/>
                            </svg>
                            <div class="scanline" *ngIf="autotuneStatus?.running"></div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="flex-grow-1 w-full">
                        <div class="flex flex-column md:flex-row align-items-start md:align-items-center gap-2 mb-2">
                            <span class="font-bold">Auto-Tune</span>
                            <span class="text-500 text-sm" *ngIf="autotuneStatus">
                                {{getAutotuneStateLabel(autotuneStatus.stateCode)}}
                                <span *ngIf="autotuneStatus.running"> - {{autotuneStatus?.progress || 0}}%</span>
                            </span>
                        </div>

                        <!-- Profile Dropdown + Start Button -->
                        <div class="flex flex-column md:flex-row gap-2">
                            <p-dropdown [options]="autotuneModeOptions"
                                        [(ngModel)]="selectedAutotuneMode"
                                        optionLabel="label"
                                        optionValue="value"
                                        placeholder="Select Mode"
                                        styleClass="w-full md:w-12rem">
                            </p-dropdown>

                            <ng-container *ngIf="!autotuneStatus?.running">
                                <button pButton label="Start" icon="pi pi-play"
                                        class="p-button-success p-button-sm"
                                        (click)="startAutotune()"
                                        [disabled]="autotuneLoading"
                                        [loading]="autotuneLoading">
                                </button>
                            </ng-container>
                            <ng-container *ngIf="autotuneStatus?.running">
                                <button pButton label="Stop" icon="pi pi-stop"
                                        class="p-button-danger p-button-sm"
                                        (click)="stopAutotune(false)"
                                        [loading]="autotuneLoading">
                                </button>
                                <button pButton label="Apply Best" icon="pi pi-check"
                                        class="p-button-success p-button-sm"
                                        (click)="stopAutotune(true)"
                                        [loading]="autotuneLoading">
                                </button>
                            </ng-container>
                        </div>

                        <!-- Progress bar when running -->
                        <div *ngIf="autotuneStatus?.running" class="mt-2">
                            <p-progressBar [value]="autotuneStatus?.progress || 0" [showValue]="false" styleClass="h-0.5rem"></p-progressBar>
                            <div class="flex justify-content-between text-xs text-500 mt-1">
                                <span>{{autotuneStatus?.currentFrequency || 0}} MHz &#64; {{autotuneStatus?.currentVoltage || 0}} mV</span>
                                <span>Test {{autotuneStatus?.testsCompleted || 0}}/{{autotuneStatus?.testsTotal || 0}}</span>
                            </div>
                        </div>

                        <!-- Best result when found -->
                        <div *ngIf="(autotuneStatus?.bestFrequency || 0) > 0 && !autotuneStatus?.running" class="mt-2 text-sm">
                            <span class="text-500">Best: </span>
                            <span class="text-green-500 font-medium">
                                {{autotuneStatus?.bestFrequency}} MHz &#64; {{autotuneStatus?.bestVoltage}} mV
                                ({{autotuneStatus?.bestEfficiency | number:'1.1-1'}} J/TH)
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connected Slaves Header -->
            <div class="flex justify-content-between align-items-center mb-3" *ngIf="status.slaves && status.slaves.length > 0">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-server text-primary text-xl"></i>
                    <h3 class="m-0">Connected Slaves</h3>
                    <span class="text-500">({{status.activeSlaves || status.slaves.length}})</span>
                </div>
                <div class="flex gap-2">
                    <button pButton icon="pi pi-bolt" class="p-button-sm p-button-outlined p-button-rounded"
                            (click)="openBulkAction('frequency')" pTooltip="Set frequency on all"></button>
                    <button pButton icon="pi pi-sliders-h" class="p-button-sm p-button-outlined p-button-rounded"
                            (click)="openBulkAction('voltage')" pTooltip="Set voltage on all"></button>
                    <button pButton icon="pi pi-refresh" class="p-button-sm p-button-danger p-button-outlined p-button-rounded"
                            (click)="openBulkAction('restart')" pTooltip="Restart all"></button>
                </div>
            </div>

            <!-- Slave List -->
            <ng-container *ngIf="status.slaves && status.slaves.length > 0; else noSlaves">
                <div class="slave-list">
                    <ng-container *ngFor="let slave of status.slaves; trackBy: trackBySlave">
                        <!-- Slave Card -->
                        <div class="surface-card border-round p-3 mb-2 cursor-pointer hover:surface-hover transition-colors transition-duration-150"
                             [ngClass]="{'border-primary border-2': expandedSlaveId === slave.slot, 'border-1 border-transparent': expandedSlaveId !== slave.slot}"
                             (click)="toggleSlaveConfig(slave)">
                            <div class="grid align-items-center">
                                <!-- Left: Status + Name -->
                                <div class="col-12 md:col-3 flex align-items-center gap-2">
                                    <i class="pi {{getSlaveStateIcon(slave.state)}} text-lg"
                                       [ngClass]="clusterService.getSlaveStateClass(slave.state)"></i>
                                    <div>
                                        <div class="font-bold">{{slave.hostname}}</div>
                                        <div class="text-xs text-400">
                                            <span *ngIf="slave.ipAddr">{{slave.ipAddr}}</span>
                                            <span *ngIf="!slave.ipAddr">ESP-NOW</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Center: Stats with Icons -->
                                <div class="col-12 md:col-7">
                                    <div class="flex justify-content-center gap-3 md:gap-5 flex-wrap">
                                        <!-- Hashrate -->
                                        <div class="flex align-items-center gap-2">
                                            <i class="pi pi-chart-line text-green-500"></i>
                                            <div>
                                                <div class="text-xs text-500">Hashrate</div>
                                                <div class="font-bold text-green-500">{{formatHashrate(slave.hashrate)}}</div>
                                            </div>
                                        </div>
                                        <!-- Temp -->
                                        <div class="flex align-items-center gap-2">
                                            <i class="pi pi-sun" [ngClass]="{'text-orange-500': slave.temperature > 60, 'text-red-500': slave.temperature > 70, 'text-blue-500': slave.temperature <= 60}"></i>
                                            <div>
                                                <div class="text-xs text-500">Temp</div>
                                                <div class="font-bold" [ngClass]="{'text-orange-500': slave.temperature > 60, 'text-red-500': slave.temperature > 70}">{{slave.temperature | number:'1.0-0'}}°C</div>
                                            </div>
                                        </div>
                                        <!-- Power -->
                                        <div class="flex align-items-center gap-2">
                                            <i class="pi pi-bolt text-yellow-500"></i>
                                            <div>
                                                <div class="text-xs text-500">Power</div>
                                                <div class="font-bold">{{slave.power | number:'1.1-1'}}W</div>
                                            </div>
                                        </div>
                                        <!-- Shares -->
                                        <div class="flex align-items-center gap-2">
                                            <i class="pi pi-check-circle text-green-500"></i>
                                            <div>
                                                <div class="text-xs text-500">Shares</div>
                                                <div>
                                                    <span class="font-bold text-green-500">{{slave.sharesAccepted}}</span>
                                                    <span class="text-red-500 text-sm" *ngIf="(slave.sharesSubmitted - slave.sharesAccepted) > 0">/{{slave.sharesSubmitted - slave.sharesAccepted}}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right: Expand -->
                                <div class="col-12 md:col-2 flex justify-content-end align-items-center gap-2">
                                    <span class="text-xs text-400 hidden md:inline">{{formatLastSeen(slave.lastSeen)}}</span>
                                    <i class="pi text-lg text-500"
                                       [ngClass]="expandedSlaveId === slave.slot ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Expanded Configuration Panel -->
                        <div class="surface-card border-round p-4 mb-3 ml-4 border-left-3 border-primary"
                             *ngIf="expandedSlaveId === slave.slot"
                             @fadeInOut>
                            <ng-container *ngIf="loadingSlaveConfig === slave.slot; else configPanel">
                                <div class="flex justify-content-center py-4">
                                    <i class="pi pi-spin pi-spinner text-2xl"></i>
                                </div>
                            </ng-container>

                            <ng-template #configPanel>
                                <div class="grid">
                                    <!-- Device Info Column -->
                                    <div class="col-12 md:col-4">
                                        <h4 class="mt-0 mb-3">Device Info</h4>
                                        <div class="flex flex-column gap-2" *ngIf="getSlaveConfig(slave.slot) as config">
                                            <div class="flex justify-content-between">
                                                <span class="text-500">Model:</span>
                                                <span>{{config.deviceModel}}</span>
                                            </div>
                                            <div class="flex justify-content-between">
                                                <span class="text-500">Firmware:</span>
                                                <span>{{config.fwVersion}}</span>
                                            </div>
                                            <div class="flex justify-content-between">
                                                <span class="text-500">Uptime:</span>
                                                <span>{{config.uptime | number:'1.0-0'}}s</span>
                                            </div>
                                            <div class="flex justify-content-between">
                                                <span class="text-500">Free Heap:</span>
                                                <span>{{config.freeHeap | number:'1.0-0'}} bytes</span>
                                            </div>
                                            <div class="flex justify-content-between">
                                                <span class="text-500">Efficiency:</span>
                                                <span>{{config.efficiency | number:'1.1-1'}} J/TH</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Mining Settings Column -->
                                    <div class="col-12 md:col-4">
                                        <h4 class="mt-0 mb-3">Mining Settings</h4>
                                        <div class="flex flex-column gap-3">
                                            <!-- Frequency -->
                                            <div class="flex align-items-center gap-2">
                                                <label class="w-6rem text-500">Frequency:</label>
                                                <p-inputNumber [(ngModel)]="editFrequency"
                                                               [min]="200" [max]="800"
                                                               suffix=" MHz"
                                                               styleClass="w-8rem p-inputtext-sm">
                                                </p-inputNumber>
                                                <button pButton icon="pi pi-check" class="p-button-sm p-button-success"
                                                        (click)="saveSlaveFrequency(slave.slot); $event.stopPropagation()"
                                                        [loading]="savingSlaveConfig === slave.slot"
                                                        pTooltip="Apply frequency"></button>
                                            </div>
                                            <!-- Voltage -->
                                            <div class="flex align-items-center gap-2">
                                                <label class="w-6rem text-500">Voltage:</label>
                                                <p-inputNumber [(ngModel)]="editVoltage"
                                                               [min]="1000" [max]="1300"
                                                               suffix=" mV"
                                                               styleClass="w-8rem p-inputtext-sm">
                                                </p-inputNumber>
                                                <button pButton icon="pi pi-check" class="p-button-sm p-button-success"
                                                        (click)="saveSlaveVoltage(slave.slot); $event.stopPropagation()"
                                                        [loading]="savingSlaveConfig === slave.slot"
                                                        pTooltip="Apply voltage"></button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cooling Settings Column -->
                                    <div class="col-12 md:col-4">
                                        <h4 class="mt-0 mb-3">Cooling Settings</h4>
                                        <div class="flex flex-column gap-3">
                                            <!-- Fan Mode -->
                                            <div class="flex align-items-center gap-2">
                                                <label class="w-6rem text-500">Fan Mode:</label>
                                                <p-dropdown [options]="fanModeOptions"
                                                            [(ngModel)]="editFanMode"
                                                            optionLabel="label"
                                                            optionValue="value"
                                                            styleClass="w-8rem"
                                                            (onChange)="saveSlaveFanMode(slave.slot)"
                                                            (click)="$event.stopPropagation()">
                                                </p-dropdown>
                                            </div>
                                            <!-- Fan Speed (only if manual) -->
                                            <div class="flex align-items-center gap-2" *ngIf="editFanMode === 1">
                                                <label class="w-6rem text-500">Fan Speed:</label>
                                                <p-inputNumber [(ngModel)]="editFanSpeed"
                                                               [min]="0" [max]="100"
                                                               suffix="%"
                                                               styleClass="w-8rem p-inputtext-sm">
                                                </p-inputNumber>
                                                <button pButton icon="pi pi-check" class="p-button-sm p-button-success"
                                                        (click)="saveSlaveFanSpeed(slave.slot); $event.stopPropagation()"
                                                        [loading]="savingSlaveConfig === slave.slot"
                                                        pTooltip="Apply fan speed"></button>
                                            </div>
                                            <!-- Target Temp (only if auto) -->
                                            <div class="flex align-items-center gap-2" *ngIf="editFanMode === 0">
                                                <label class="w-6rem text-500">Target Temp:</label>
                                                <p-inputNumber [(ngModel)]="editTargetTemp"
                                                               [min]="40" [max]="75"
                                                               suffix="&deg;C"
                                                               styleClass="w-8rem p-inputtext-sm">
                                                </p-inputNumber>
                                                <button pButton icon="pi pi-check" class="p-button-sm p-button-success"
                                                        (click)="saveSlaveTargetTemp(slave.slot); $event.stopPropagation()"
                                                        [loading]="savingSlaveConfig === slave.slot"
                                                        pTooltip="Apply target temp"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Slave Auto-Tune Section -->
                                <div class="mt-4 pt-3 border-top-1 surface-border">
                                    <div class="flex justify-content-between align-items-center mb-3">
                                        <div class="flex align-items-center gap-2">
                                            <i class="pi pi-sliders-v text-primary"></i>
                                            <h4 class="m-0">Auto-Tune</h4>
                                        </div>
                                        <button pButton icon="pi pi-refresh" class="p-button-text p-button-sm"
                                                (click)="refreshSlaveAutotune(slave.slot); $event.stopPropagation()"
                                                [loading]="slaveAutotuneLoading === slave.slot"
                                                pTooltip="Refresh autotune status"></button>
                                    </div>

                                    <!-- Autotune Status -->
                                    <ng-container *ngIf="getSlaveAutotuneStatus(slave.slot) as slaveAutotune">
                                        <div class="grid">
                                            <!-- Status Display -->
                                            <div class="col-12 md:col-6">
                                                <div class="surface-ground border-round p-3">
                                                    <div class="flex justify-content-between mb-2">
                                                        <span class="text-500">Status:</span>
                                                        <span [ngClass]="getAutotuneStateClass(slaveAutotune.stateCode)" class="font-medium">
                                                            {{getAutotuneStateLabel(slaveAutotune.stateCode)}}
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-content-between mb-2" *ngIf="slaveAutotune.running">
                                                        <span class="text-500">Progress:</span>
                                                        <span class="font-medium">{{slaveAutotune.progress}}%</span>
                                                    </div>
                                                    <div class="flex justify-content-between mb-2" *ngIf="slaveAutotune.running">
                                                        <span class="text-500">Testing:</span>
                                                        <span class="font-medium">{{slaveAutotune.currentFrequency}} MHz &#64; {{slaveAutotune.currentVoltage}} mV</span>
                                                    </div>
                                                    <div class="flex justify-content-between" *ngIf="slaveAutotune.mode">
                                                        <span class="text-500">Mode:</span>
                                                        <span class="font-medium capitalize">{{slaveAutotune.mode}}</span>
                                                    </div>
                                                    <!-- Progress bar when running -->
                                                    <div *ngIf="slaveAutotune.running" class="mt-2">
                                                        <p-progressBar [value]="slaveAutotune.progress" [showValue]="false" styleClass="h-0.5rem"></p-progressBar>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Best Found Values -->
                                            <div class="col-12 md:col-6" *ngIf="slaveAutotune.bestFrequency > 0">
                                                <div class="surface-ground border-round p-3">
                                                    <div class="text-500 text-sm mb-2">Best Settings Found</div>
                                                    <div class="grid">
                                                        <div class="col-6">
                                                            <div class="text-xs text-500">Frequency</div>
                                                            <div class="font-bold text-green-500">{{slaveAutotune.bestFrequency}} MHz</div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="text-xs text-500">Voltage</div>
                                                            <div class="font-bold text-green-500">{{slaveAutotune.bestVoltage}} mV</div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="text-xs text-500">Efficiency</div>
                                                            <div class="font-medium">{{slaveAutotune.bestEfficiency | number:'1.2-2'}} J/TH</div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="text-xs text-500">Hashrate</div>
                                                            <div class="font-medium">{{slaveAutotune.bestHashrate | number:'1.2-2'}} GH/s</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Autotune Action Buttons -->
                                        <div class="flex gap-2 mt-3">
                                            <ng-container *ngIf="!slaveAutotune.running">
                                                <button pButton label="Start Auto-Tune" icon="pi pi-play"
                                                        class="p-button-sm p-button-outlined"
                                                        (click)="openSlaveAutotuneDialog(slave.slot); $event.stopPropagation()"
                                                        [loading]="slaveAutotuneLoading === slave.slot">
                                                </button>
                                            </ng-container>
                                            <ng-container *ngIf="slaveAutotune.running">
                                                <button pButton label="Stop & Revert" icon="pi pi-times"
                                                        class="p-button-sm p-button-outlined p-button-secondary"
                                                        (click)="stopSlaveAutotune(slave.slot, false); $event.stopPropagation()"
                                                        [loading]="slaveAutotuneLoading === slave.slot">
                                                </button>
                                                <button pButton label="Stop & Apply Best" icon="pi pi-check"
                                                        class="p-button-sm p-button-success"
                                                        (click)="stopSlaveAutotune(slave.slot, true); $event.stopPropagation()"
                                                        [loading]="slaveAutotuneLoading === slave.slot">
                                                </button>
                                            </ng-container>
                                        </div>
                                    </ng-container>

                                    <!-- No autotune data yet -->
                                    <ng-container *ngIf="!getSlaveAutotuneStatus(slave.slot)">
                                        <div class="surface-ground border-round p-3">
                                            <div class="flex align-items-center gap-2 mb-2">
                                                <i class="pi pi-info-circle text-blue-500"></i>
                                                <span class="text-500 text-sm">
                                                    <span *ngIf="!slave.ipAddr">ESP-NOW slaves require direct access for autotune.</span>
                                                    <span *ngIf="slave.ipAddr">Click refresh to load autotune status.</span>
                                                </span>
                                            </div>
                                            <div class="flex gap-2" *ngIf="slave.ipAddr">
                                                <button pButton label="Start Auto-Tune" icon="pi pi-play"
                                                        class="p-button-sm p-button-outlined"
                                                        (click)="openSlaveAutotuneDialog(slave.slot); $event.stopPropagation()"
                                                        [loading]="slaveAutotuneLoading === slave.slot">
                                                </button>
                                            </div>
                                            <a *ngIf="slave.ipAddr"
                                               [href]="'http://' + slave.ipAddr"
                                               target="_blank"
                                               class="text-xs text-primary"
                                               (click)="$event.stopPropagation()">
                                                Open slave web UI
                                            </a>
                                        </div>
                                    </ng-container>
                                </div>

                                <!-- Cluster Autotune Toggle -->
                                <div class="mt-3 pt-3 border-top-1 surface-border">
                                    <div class="flex align-items-center gap-3">
                                        <p-checkbox [ngModel]="isSlaveAutotuneIncluded(slave.slot)"
                                                    (ngModelChange)="toggleSlaveAutotuneIncluded(slave.slot)"
                                                    [binary]="true"
                                                    [inputId]="'slaveAutotune' + slave.slot"
                                                    (click)="$event.stopPropagation()">
                                        </p-checkbox>
                                        <label [for]="'slaveAutotune' + slave.slot" class="cursor-pointer" (click)="$event.stopPropagation()">
                                            Include in cluster auto-tune
                                        </label>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex justify-content-end gap-2 mt-3 pt-3 border-top-1 surface-border">
                                    <button pButton label="Identify" icon="pi pi-lightbulb" class="p-button-sm p-button-outlined"
                                            (click)="identifySlave(slave.slot); $event.stopPropagation()"
                                            pTooltip="Flash LED to identify device"></button>
                                    <button pButton label="Restart" icon="pi pi-refresh" class="p-button-sm p-button-danger p-button-outlined"
                                            (click)="restartSlave(slave.slot); $event.stopPropagation()"
                                            pTooltip="Restart this slave"></button>
                                </div>
                            </ng-template>
                        </div>
                    </ng-container>
                </div>
                <!-- Cluster Power Summary -->
                <div class="mt-3 surface-card border-round p-3" *ngIf="status.slaves && status.slaves.length > 0">
                    <div class="flex justify-content-between align-items-center">
                        <span class="text-500">Total Cluster Power:</span>
                        <span class="font-bold text-lg">{{getTotalPower(status.slaves) | number:'1.1-1'}} W</span>
                    </div>
                </div>
            </ng-container>
            <ng-template #noSlaves>
                <div class="text-center py-4 surface-card border-round">
                    <i class="pi pi-users text-3xl text-500 mb-2"></i>
                    <p class="text-500 m-0">No slaves connected</p>
                    <p class="text-400 text-sm mt-1">Waiting for slave devices to register...</p>
                </div>
            </ng-template>

            <!-- API Access Info -->
            <div class="mt-4 p-3 surface-card border-round">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-info-circle text-blue-500"></i>
                    <span class="font-medium">External API Access</span>
                </div>
                <p class="text-500 text-sm m-0 mb-2">
                    Both master and slave devices expose their full API. Click on a slave's IP to access its web interface directly.
                </p>
                <div class="flex flex-wrap gap-2">
                    <span class="text-400 text-sm">Master API: <code>/api/cluster/status</code></span>
                    <span class="text-400 text-sm">Slave API: <code>http://[slave-ip]/api/system/info</code></span>
                </div>
            </div>
        </ng-container>

        <!-- Slave Mode -->
        <ng-container *ngIf="status.mode === 2">
            <div class="grid">
                <div class="col-12 md:col-6">
                    <div class="surface-card shadow-1 border-round p-4">
                        <h4 class="mt-0 mb-3">Connection Status</h4>
                        <div class="flex align-items-center gap-2 mb-3">
                            <i class="pi" [ngClass]="{
                                'pi-check-circle text-green-500': status.connectedToMaster,
                                'pi-times-circle text-red-500': !status.connectedToMaster
                            }"></i>
                            <span [ngClass]="{
                                'text-green-500': status.connectedToMaster,
                                'text-red-500': !status.connectedToMaster
                            }">
                                {{status.connectedToMaster ? 'Connected to Master' : 'Disconnected'}}
                            </span>
                        </div>
                        <div class="flex flex-column gap-2">
                            <div class="flex justify-content-between">
                                <span class="text-500">Hostname:</span>
                                <span>{{status.hostname}}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 md:col-6">
                    <div class="surface-card shadow-1 border-round p-4">
                        <h4 class="mt-0 mb-3">Local Stats</h4>
                        <div class="flex flex-column gap-2">
                            <div class="flex justify-content-between">
                                <span class="text-500">Hashrate:</span>
                                <span class="text-green-500 font-medium">{{formatHashrate(status.localHashrate || 0)}}</span>
                            </div>
                            <div class="flex justify-content-between">
                                <span class="text-500">Temperature:</span>
                                <span>{{status.localTemperature | number:'1.1-1'}} &deg;C</span>
                            </div>
                            <div class="flex justify-content-between">
                                <span class="text-500">Fan RPM:</span>
                                <span>{{status.localFanRpm}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 p-3 surface-card border-round">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-info-circle text-blue-500"></i>
                    <span class="text-500">
                        In slave mode, this device receives mining work from the master and reports shares back.
                        Pool connection is handled by the master device.
                    </span>
                </div>
            </div>
        </ng-container>
</div>
</div>
</ng-container>

<ng-template #loadingTemplate>
    <div class="card">
        <div class="flex justify-content-center align-items-center py-5">
            <i class="pi pi-spin pi-spinner text-4xl"></i>
        </div>
    </div>
</ng-template>

<!-- Mode Change Confirmation Dialog -->
<p-dialog
    header="Change Cluster Mode"
    [(visible)]="showModeChangeDialog"
    [modal]="true"
    [style]="{width: '400px'}">
    <p>Changing cluster mode requires a device restart. Are you sure you want to continue?</p>
    <p class="text-orange-500 font-medium mt-2">
        <i class="pi pi-exclamation-triangle mr-2"></i>
        Mining will be interrupted during restart.
    </p>
    <ng-template pTemplate="footer">
        <button pButton label="Cancel" class="p-button-text" (click)="cancelModeChange()"></button>
        <button pButton label="Change & Restart" class="p-button-danger" (click)="confirmModeChange()"></button>
    </ng-template>
</p-dialog>

<!-- Bulk Action Dialog -->
<p-dialog
    [header]="getBulkActionTitle()"
    [(visible)]="showBulkActionDialog"
    [modal]="true"
    [style]="{width: '400px'}">

    <!-- Frequency Input -->
    <div *ngIf="bulkActionType === 'frequency'" class="flex flex-column gap-3">
        <p class="text-500 mt-0">Set the same frequency on all connected slaves.</p>
        <div class="flex align-items-center gap-2">
            <label class="w-6rem">Frequency:</label>
            <p-inputNumber [(ngModel)]="bulkFrequency"
                           [min]="200" [max]="800"
                           suffix=" MHz"
                           styleClass="flex-1">
            </p-inputNumber>
        </div>
        <p class="text-orange-500 text-sm m-0">
            <i class="pi pi-exclamation-triangle mr-1"></i>
            Higher frequencies increase power consumption and heat.
        </p>
    </div>

    <!-- Voltage Input -->
    <div *ngIf="bulkActionType === 'voltage'" class="flex flex-column gap-3">
        <p class="text-500 mt-0">Set the same core voltage on all connected slaves.</p>
        <div class="flex align-items-center gap-2">
            <label class="w-6rem">Voltage:</label>
            <p-inputNumber [(ngModel)]="bulkVoltage"
                           [min]="1000" [max]="1300"
                           suffix=" mV"
                           styleClass="flex-1">
            </p-inputNumber>
        </div>
        <p class="text-orange-500 text-sm m-0">
            <i class="pi pi-exclamation-triangle mr-1"></i>
            Higher voltages may damage hardware. Use with caution.
        </p>
    </div>

    <!-- Fan Speed Input -->
    <div *ngIf="bulkActionType === 'fan'" class="flex flex-column gap-3">
        <p class="text-500 mt-0">Set the same fan speed percentage on all connected slaves.</p>
        <div class="flex align-items-center gap-2">
            <label class="w-6rem">Fan Speed:</label>
            <p-inputNumber [(ngModel)]="bulkFanSpeed"
                           [min]="0" [max]="100"
                           suffix="%"
                           styleClass="flex-1">
            </p-inputNumber>
        </div>
        <p class="text-500 text-sm m-0">
            <i class="pi pi-info-circle mr-1"></i>
            This sets fan mode to Manual on all slaves.
        </p>
    </div>

    <!-- Restart Confirmation -->
    <div *ngIf="bulkActionType === 'restart'" class="flex flex-column gap-3">
        <p class="text-500 mt-0">This will restart all connected slave devices.</p>
        <p class="text-orange-500 font-medium m-0">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            Mining will be interrupted on all slaves during restart.
        </p>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Cancel" class="p-button-text" (click)="cancelBulkAction()"></button>
        <button pButton
                [label]="bulkActionType === 'restart' ? 'Restart All' : 'Apply to All'"
                [class]="bulkActionType === 'restart' ? 'p-button-danger' : 'p-button-primary'"
                (click)="executeBulkAction()"></button>
    </ng-template>
</p-dialog>

<!-- Autotune Mode Selection Dialog -->
<p-dialog
    header="Start Auto-Tuning"
    [(visible)]="showAutotuneDialog"
    [modal]="true"
    [style]="{width: '450px'}">

    <div class="flex flex-column gap-4">
        <p class="text-500 mt-0">
            Auto-tuning will test different frequency and voltage combinations to find the optimal settings.
        </p>

        <div class="flex flex-column gap-2">
            <label class="font-medium">Optimization Mode</label>
            <p-dropdown [options]="autotuneModeOptions"
                        [(ngModel)]="selectedAutotuneMode"
                        optionLabel="label"
                        optionValue="value"
                        styleClass="w-full">
            </p-dropdown>
        </div>

        <div class="surface-ground border-round p-3">
            <div class="flex flex-column gap-2 text-sm">
                <div *ngIf="selectedAutotuneMode === 'efficiency'">
                    <i class="pi pi-bolt text-green-500 mr-2"></i>
                    <strong>Efficiency Mode:</strong> Best J/TH ratio with low voltage. Tests up to 550 MHz and 1175 mV max.
                </div>
                <div *ngIf="selectedAutotuneMode === 'hashrate'">
                    <i class="pi pi-chart-line text-blue-500 mr-2"></i>
                    <strong>Max Hashrate:</strong> Pushes frequency and voltage to find highest hashrate within temperature limits. Up to 800 MHz and 1300 mV.
                </div>
                <div *ngIf="selectedAutotuneMode === 'balanced'">
                    <i class="pi pi-sliders-h text-orange-500 mr-2"></i>
                    <strong>Balanced Mode:</strong> Good performance without excessive power. Tests up to 725 MHz and 1200 mV max.
                </div>
            </div>
        </div>

        <div class="text-orange-500 text-sm">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            Auto-tuning may take several minutes to complete. Mining will continue during this process.
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Cancel" class="p-button-text" (click)="showAutotuneDialog = false"></button>
        <button pButton label="Start" icon="pi pi-play" class="p-button-primary" (click)="startAutotune()"></button>
    </ng-template>
</p-dialog>

<!-- Slave Autotune Mode Selection Dialog -->
<p-dialog
    header="Start Slave Auto-Tuning"
    [(visible)]="showSlaveAutotuneDialog"
    [modal]="true"
    [style]="{width: '450px'}">

    <div class="flex flex-column gap-4">
        <p class="text-500 mt-0">
            Auto-tuning will test different frequency and voltage combinations on the selected slave to find optimal settings.
        </p>

        <div class="flex flex-column gap-2">
            <label class="font-medium">Optimization Mode</label>
            <p-dropdown [options]="autotuneModeOptions"
                        [(ngModel)]="slaveAutotuneMode"
                        optionLabel="label"
                        optionValue="value"
                        styleClass="w-full">
            </p-dropdown>
        </div>

        <div class="surface-ground border-round p-3">
            <div class="flex flex-column gap-2 text-sm">
                <div *ngIf="slaveAutotuneMode === 'efficiency'">
                    <i class="pi pi-bolt text-green-500 mr-2"></i>
                    <strong>Efficiency Mode:</strong> Best J/TH ratio with low voltage. Tests up to 550 MHz and 1175 mV max.
                </div>
                <div *ngIf="slaveAutotuneMode === 'hashrate'">
                    <i class="pi pi-chart-line text-blue-500 mr-2"></i>
                    <strong>Max Hashrate:</strong> Pushes frequency and voltage to find highest hashrate within temperature limits. Up to 800 MHz and 1300 mV.
                </div>
                <div *ngIf="slaveAutotuneMode === 'balanced'">
                    <i class="pi pi-sliders-h text-orange-500 mr-2"></i>
                    <strong>Balanced Mode:</strong> Good performance without excessive power. Tests up to 725 MHz and 1200 mV max.
                </div>
            </div>
        </div>

        <div class="text-orange-500 text-sm">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            Auto-tuning is performed via HTTP proxy to the slave. This may take several minutes.
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Cancel" class="p-button-text" (click)="showSlaveAutotuneDialog = false"></button>
        <button pButton label="Start" icon="pi pi-play" class="p-button-primary"
                (click)="startSlaveAutotune()"
                [loading]="slaveAutotuneLoading !== null">
        </button>
    </ng-template>
</p-dialog>

<!-- Save Profile Dialog -->
<p-dialog
    header="Save Current Settings as Profile"
    [(visible)]="showSaveProfileDialog"
    [modal]="true"
    [style]="{width: '400px'}">

    <div class="flex flex-column gap-4">
        <p class="text-500 mt-0">
            Save the current autotune settings as a reusable profile.
        </p>

        <div class="flex flex-column gap-2">
            <label class="font-medium">Profile Name</label>
            <input type="text" pInputText [(ngModel)]="newProfileName"
                   placeholder="e.g., Efficiency Max, Summer Settings"
                   class="w-full">
        </div>

        <div class="surface-ground border-round p-3" *ngIf="autotuneStatus">
            <div class="text-500 text-sm mb-2">Settings to Save</div>
            <div class="flex gap-4">
                <div>
                    <span class="text-500">Frequency:</span>
                    <span class="font-bold ml-1">
                        {{autotuneStatus.bestFrequency || autotuneStatus.currentFrequency}} MHz
                    </span>
                </div>
                <div>
                    <span class="text-500">Voltage:</span>
                    <span class="font-bold ml-1">
                        {{autotuneStatus.bestVoltage || autotuneStatus.currentVoltage}} mV
                    </span>
                </div>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Cancel" class="p-button-text" (click)="showSaveProfileDialog = false"></button>
        <button pButton label="Save Profile" icon="pi pi-save" class="p-button-primary"
                (click)="saveCurrentAsProfile()"
                [disabled]="!newProfileName.trim()">
        </button>
    </ng-template>
</p-dialog>

<!-- Apply Profile Dialog -->
<p-dialog
    header="Apply Profile"
    [(visible)]="showApplyProfileDialog"
    [modal]="true"
    [style]="{width: '450px'}">

    <div class="flex flex-column gap-4" *ngIf="selectedProfileSlot !== null">
        <ng-container *ngIf="getProfileBySlot(selectedProfileSlot) as profile">
            <div class="surface-ground border-round p-3">
                <div class="font-bold text-lg mb-2">{{profile.name}}</div>
                <div class="flex gap-4">
                    <div>
                        <span class="text-500">Frequency:</span>
                        <span class="font-bold ml-1">{{profile.frequency}} MHz</span>
                    </div>
                    <div>
                        <span class="text-500">Voltage:</span>
                        <span class="font-bold ml-1">{{profile.voltage}} mV</span>
                    </div>
                </div>
            </div>
        </ng-container>

        <div class="flex flex-column gap-2">
            <label class="font-medium">Apply To</label>
            <p-dropdown [options]="[
                    {label: 'Master Device', value: 'master'},
                    {label: 'Specific Slave', value: 'slave'},
                    {label: 'All Devices', value: 'all'}
                ]"
                        [(ngModel)]="profileApplyTarget"
                        optionLabel="label"
                        optionValue="value"
                        styleClass="w-full">
            </p-dropdown>
        </div>

        <div class="flex flex-column gap-2" *ngIf="profileApplyTarget === 'slave'">
            <label class="font-medium">Select Slave</label>
            <p-inputNumber [(ngModel)]="profileApplySlaveId"
                           [min]="0"
                           placeholder="Slave ID"
                           styleClass="w-full">
            </p-inputNumber>
        </div>

        <div class="text-orange-500 text-sm">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            Settings will be applied immediately. Mining may be briefly interrupted.
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Cancel" class="p-button-text" (click)="showApplyProfileDialog = false"></button>
        <button pButton label="Apply" icon="pi pi-play" class="p-button-primary"
                (click)="applyProfile()">
        </button>
    </ng-template>
</p-dialog>

<!-- Toast for notifications -->
<p-toast></p-toast>
