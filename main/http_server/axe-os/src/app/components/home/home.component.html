<ng-template #noValue>--</ng-template>

<ng-template #powerFault>
    <span class="text-red-500">
        Not available - Power fault
    </span>
</ng-template>

<!-- Matrix Hash Animation Overlay -->
<div class="matrix-container" [ngClass]="{'active': matrixActive, 'fading': matrixFading}">
    <div *ngFor="let column of matrixColumns"
         class="matrix-column speed-{{column.speed}}"
         [style.left]="column.left + '%'"
         [style.color]="column.color">
        <span *ngFor="let char of column.chars" class="matrix-char">{{char}}</span>
    </div>
</div>

<ng-container *ngIf="info$ | async as info">
    <ng-container *ngFor="let message of messages">
        <p-message
            [severity]="message.severity"
            [text]="message.text"
            [styleClass]="'w-full mb-3 py-3 border-round-lg'"
        />
    </ng-container>

    <p-message *ngIf="info.blockFound" severity="success" styleClass="w-full mb-4 py-4 border-round-xl"
        text="Today is your lucky day! Your device has found a block ðŸŽ‰">
    </p-message>

    <!-- Slave Mode Banner -->
    <ng-container *ngIf="clusterStatus$ | async as clusterStatus">
        <div *ngIf="clusterStatus.mode === 2" class="surface-card border-round p-3 mb-3">
            <div class="flex align-items-center gap-3">
                <div class="flex align-items-center justify-content-center bg-blue-100 border-round" style="width: 48px; height: 48px;">
                    <i class="pi pi-wifi text-blue-600 text-2xl"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="flex align-items-center gap-2 mb-1">
                        <span class="font-bold text-lg">Slave Mode</span>
                        <span class="text-xs px-2 py-1 border-round font-medium"
                            [ngClass]="clusterStatus.connectedToMaster ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                            {{clusterStatus.connectedToMaster ? 'Connected to Master' : 'Disconnected'}}
                        </span>
                    </div>
                    <div class="text-500 text-sm">
                        <i class="pi pi-broadcast mr-1"></i>
                        ESP-NOW cluster member &bull; Shares forwarded to master
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-primary">{{info.hashRate | hashSuffix}}</div>
                    <div class="text-500 text-xs">Local Hashrate</div>
                </div>
            </div>
        </div>
    </ng-container>

    <!-- Cluster Summary (Master Mode Only) -->
    <ng-container *ngIf="clusterStatus$ | async as clusterStatus">
        <div class="grid mb-3" *ngIf="clusterStatus.mode === 1">
            <div class="col-12">
                <div class="surface-card border-round p-3 mb-2">
                    <div class="flex align-items-center justify-content-between mb-3">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-server text-primary text-xl"></i>
                            <span class="text-xl font-bold">Cluster</span>
                            <span class="px-2 py-1 bg-primary text-white border-round text-xs">{{clusterStatus.activeSlaves || 0}} Slaves</span>
                        </div>
                        <a routerLink="/cluster" class="text-primary text-sm">
                            <i class="pi pi-cog mr-1"></i>Manage
                        </a>
                    </div>
                    <div class="grid">
                        <!-- Master Hashrate -->
                        <div class="col-6 md:col-3">
                            <div class="text-center p-2 surface-ground border-round">
                                <div class="flex align-items-center justify-content-center gap-1 mb-1">
                                    <i class="pi pi-desktop text-xs text-500"></i>
                                    <span class="text-500 text-xs">Master</span>
                                </div>
                                <div class="text-xl font-bold text-primary">{{info.hashRate | hashSuffix}}</div>
                            </div>
                        </div>
                        <!-- Total Cluster Hashrate -->
                        <div class="col-6 md:col-3">
                            <div class="text-center p-2 surface-ground border-round">
                                <div class="flex align-items-center justify-content-center gap-1 mb-1">
                                    <i class="pi pi-chart-line text-xs text-theme"></i>
                                    <span class="text-500 text-xs">Total Hashrate</span>
                                </div>
                                <div class="text-xl font-bold text-theme">{{formatClusterHashrate(getClusterTotalHashrate(clusterStatus, info.hashRate))}}</div>
                            </div>
                        </div>
                        <!-- Cluster Shares -->
                        <div class="col-6 md:col-3">
                            <div class="text-center p-2 surface-ground border-round">
                                <div class="flex align-items-center justify-content-center gap-1 mb-1">
                                    <i class="pi pi-check-circle text-xs text-theme"></i>
                                    <span class="text-500 text-xs">Total Shares</span>
                                </div>
                                <div class="text-xl font-bold">
                                    <span class="text-theme">{{getClusterTotalShares(clusterStatus, info.sharesAccepted) | number:'1.0-0'}}</span>
                                    <span class="text-red-500 text-sm" *ngIf="getClusterTotalRejected(clusterStatus, info.sharesRejected) > 0">/{{getClusterTotalRejected(clusterStatus, info.sharesRejected)}}</span>
                                </div>
                            </div>
                        </div>
                        <!-- Cluster Power -->
                        <div class="col-6 md:col-3">
                            <div class="text-center p-2 surface-ground border-round">
                                <div class="flex align-items-center justify-content-center gap-1 mb-1">
                                    <i class="pi pi-bolt text-xs text-yellow-500"></i>
                                    <span class="text-500 text-xs">Total Power</span>
                                </div>
                                <div class="text-xl font-bold">{{getTotalClusterPower(clusterStatus, info.power) | number:'1.0-0'}} W</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-container>

    <div class="grid">
        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex flex-column justify-content-between">
                    <span class="block text-lg font-medium mb-3">
                        <ng-container *ngIf="isMasterMode">Device Hashrate</ng-container>
                        <ng-container *ngIf="!isMasterMode">Hashrate</ng-container>
                    </span>

                    <ng-container *ngIf="!info.power_fault; else powerFault">
                        <div class="flex align-items-center justify-content-between gap-2 mb-3">
                            <span class="text-900 font-medium text-2xl white-space-nowrap">
                                {{info.hashRate | hashSuffix}}
                            </span>
                            <table class="text-xs">
                                <thead>
                                    <tr>
                                        <th class="p-0 text-400 font-normal line-height-1 cursor-pointer" pTooltip="Hash error percentage as reported by the ASIC. A small amount of errors every few seconds is normal. Frequency changes, agressive overclocking, undervoltage or a bad power supply can significantly increase the error rate.">
                                            Error
                                        </th>
                                        <th *ngIf="info.expectedHashrate" class="p-0 pl-3 text-400 font-normal line-height-1">
                                            Expected
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="p-0 text-center text-800 line-height-1">
                                            {{info.errorPercentage | number: '1.2-2'}}%
                                        </td>
                                        <td *ngIf="info.expectedHashrate" class="p-0 pl-3 text-center text-800 line-height-1 white-space-nowrap">
                                            {{info.expectedHashrate | hashSuffix: { tickmark: true } }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Dual Pool Hashrate Split -->
                        <ng-container *ngIf="isDualPoolMode(info)">
                            <div class="mb-2 text-sm">
                                <div class="flex justify-content-between mb-1">
                                    <span class="text-500">Primary ({{getDualPoolPrimaryPercentage(info)}}%):</span>
                                    <span class="text-theme font-medium">{{getPrimaryHashrate(info) | hashSuffix}}</span>
                                </div>
                                <div class="flex justify-content-between">
                                    <span class="text-500">Secondary ({{getDualPoolSecondaryPercentage(info)}}%):</span>
                                    <span class="text-blue-500 font-medium">{{getSecondaryHashrate(info) | hashSuffix}}</span>
                                </div>
                            </div>
                            <!-- Visual hashrate split bar -->
                            <div class="flex w-full h-1rem border-round overflow-hidden mb-2">
                                <div class="bg-green-500" [style.width]="getDualPoolPrimaryPercentage(info) + '%'"></div>
                                <div class="bg-blue-500" [style.width]="getDualPoolSecondaryPercentage(info) + '%'"></div>
                            </div>
                        </ng-container>

                        <table class="px-1 border-1 border-50 border-round-xs">
                            <thead>
                                <tr>
                                    <th *ngFor="let i of hashrateAverages" class="p-0 text-500 font-normal line-height-1">
                                        {{i.label}}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td *ngFor="let i of hashrateAverages" class="p-0 text-center text-theme font-medium">
                                        {{ info[i.key] | hashSuffix }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </ng-container>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex flex-column justify-content-between">
                    <span class="block text-lg font-medium mb-3">Efficiency</span>

                    <ng-container *ngIf="!info.power_fault; else powerFault">
                        <div class="flex align-items-center justify-content-between gap-2 mb-3">
                            <span class="text-900 font-medium text-2xl white-space-nowrap">
                                {{getEfficiency(info) | number: '1.2-2'}} J/Th
                            </span>
                            <table class="text-xs">
                                <thead>
                                    <tr>
                                        <th class="p-0 text-400 font-normal line-height-1">
                                            Expected
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="p-0 text-center text-800 line-height-1 white-space-nowrap">
                                            {{getExpectedEfficiency(info) | number: '1.2-2'}} J/Th
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div>
                            <span class="text-theme font-medium white-space-nowrap">
                                {{getEfficiencyAverage() | number: '1.2-2'}} J/Th
                            </span>
                            <span class="text-500">
                                Average
                            </span>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <!-- Slave Mode: Show shares sent to master -->
                        <ng-container *ngIf="isSlaveMode; else normalSharesDisplay">
                            <ng-container *ngIf="clusterStatus$ | async as clusterStatus">
                                <span class="block text-lg font-medium mb-3">Shares to Master</span>
                                <div class="text-900 font-medium text-2xl">
                                    {{clusterStatus.sharesSubmitted || 0 | number: '1.0-0'}}
                                </div>
                            </ng-container>
                        </ng-container>
                        <!-- Normal/Master Mode: Show shares -->
                        <ng-template #normalSharesDisplay>
                            <span class="block text-lg font-medium mb-3">
                                <ng-container *ngIf="isMasterMode">Device Shares</ng-container>
                                <ng-container *ngIf="!isMasterMode">Shares</ng-container>
                            </span>
                            <!-- Standard shares display (Failover mode) -->
                            <div *ngIf="!isDualPoolMode(info)" class="text-900 font-medium text-2xl">
                                {{info.sharesAccepted | number: '1.0-0'}}
                            </div>
                            <!-- Dual Pool mode shares display -->
                            <div *ngIf="isDualPoolMode(info)" class="text-900 font-medium text-2xl">
                                {{getDualPoolTotalAccepted(info) | number: '1.0-0'}}
                                <span class="text-500 text-sm">total</span>
                            </div>
                        </ng-template>
                    </div>
                </div>
                <!-- Dual Pool per-pool breakdown -->
                <ng-container *ngIf="isDualPoolMode(info) && info.dualPoolStats">
                    <div class="mb-2 text-sm">
                        <div class="flex justify-content-between">
                            <span class="text-500">Primary ({{getDualPoolPrimaryPercentage(info)}}%):</span>
                            <span>
                                <span class="text-theme font-medium">{{info.dualPoolStats.primaryAccepted | number: '1.0-0'}}</span>
                                <span class="text-500"> / </span>
                                <span class="text-red-500">{{info.dualPoolStats.primaryRejected | number: '1.0-0'}}</span>
                            </span>
                        </div>
                        <div class="flex justify-content-between">
                            <span class="text-500">Secondary ({{getDualPoolSecondaryPercentage(info)}}%):</span>
                            <span>
                                <span class="text-theme font-medium">{{info.dualPoolStats.secondaryAccepted | number: '1.0-0'}}</span>
                                <span class="text-500"> / </span>
                                <span class="text-red-500">{{info.dualPoolStats.secondaryRejected | number: '1.0-0'}}</span>
                            </span>
                        </div>
                        <div class="flex align-items-center gap-1 mt-1">
                            <i class="pi pi-circle-fill text-xs" [ngClass]="{'text-green-500': info.secondaryPoolConnected, 'text-red-500': !info.secondaryPoolConnected}"></i>
                            <span class="text-500 text-xs">Secondary: {{getSecondaryPoolConnectionStatus(info)}}</span>
                        </div>
                    </div>
                </ng-container>
                <!-- Slave Mode: Show connection info -->
                <ng-container *ngIf="isSlaveMode">
                    <ng-container *ngIf="clusterStatus$ | async as clusterStatus">
                        <div class="flex align-items-center gap-2">
                            <i class="pi" [ngClass]="clusterStatus.connectedToMaster ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-500'"></i>
                            <span [ngClass]="clusterStatus.connectedToMaster ? 'text-green-500' : 'text-red-500'">
                                {{clusterStatus.connectedToMaster ? 'Connected to Master' : 'Disconnected'}}
                            </span>
                        </div>
                    </ng-container>
                </ng-container>
                <!-- Standard rejection display (Failover mode) -->
                <ng-container *ngIf="!isDualPoolMode(info) && !isSlaveMode">
                    <div *ngIf="info.sharesRejected === 0">
                        <span class="text-red-500 font-medium">0 </span>
                        <span class="text-500">rejected</span>
                    </div>
                    <ng-container *ngIf="info.sharesRejected > 0">
                        <div *ngFor="let sharesRejectedReason of getSortedRejectionReasons(info); trackBy: trackByReason">
                            <span class="text-red-500 font-medium">
                                {{ sharesRejectedReason.count | number: '1.0-0' }}
                            </span>
                            <span class="text-500">
                                {{ sharesRejectedReason.message }}
                            </span>
                            <tooltip-text-icon
                                [text]="'(' + (getShareRejectionPercentage(sharesRejectedReason, info) | number:'1.2-2') + ' %)'"
                                [tooltip]="getRejectionExplanation(sharesRejectedReason.message)"
                                [split]=false />
                        </div>
                    </ng-container>
                </ng-container>
            </div>
        </div>

        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-lg font-medium mb-3">Best Difficulty</span>
                        <div class="text-900 font-medium text-2xl">
                            <span class="cursor-pointer" pTooltip="{{info.bestDiff | number:'1.0-0'}}" tooltipPosition="bottom">
                                {{info.bestDiff | diffSuffix}}
                            </span>
                            <span class="text-500 text-lg">all-time best</span>
                            <span class="text-lg font-medium mb-3" *ngIf="info.networkDifficulty">
                                <tooltip-text-icon
                                    [text]="'(' + getNetworkDifficultyPercentage(info) + '%)'"
                                    tooltip="Chance to find a Block"
                                    [split]="false"
                                />
                            </span>
                        </div>
                    </div>
                </div>
                <div>
                    <span class="text-900 font-medium cursor-pointer" pTooltip="{{info.bestSessionDiff | number:'1.0-0'}}" tooltipPosition="bottom">
                        {{info.bestSessionDiff | diffSuffix}}
                    </span>
                    <span class="text-500">since system boot</span>
                </div>
            </div>
        </div>

        <div class="col-12" *ngIf="!info.power_fault">
            <div class="card">
                <form [formGroup]="form">
                    <div class="flex flex-nowrap justify-content-between mb-3">
                        <p-dropdown
                            [options]="dataSourceLabels(info)"
                            optionLabel="name"
                            optionValue="value"
                            formControlName="chartY1Data"
                            styleClass="w-10rem border-100 p-dropdown--small">
                        </p-dropdown>
                        <p-dropdown
                            [options]="dataSourceLabels(info)"
                            optionLabel="name"
                            optionValue="value"
                            formControlName="chartY2Data"
                            styleClass="w-10rem border-100 p-dropdown--small">
                        </p-dropdown>
                    </div>

                    <p-chart #chart id="chart" [data]="chartData" [options]="chartOptions"></p-chart>
                </form>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="text-center">Power</h4>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        Power<span>{{info.power}} W</span>
                    </h6>
                    <p-progressBar [value]="(info.power / info.maxPower) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        Input Voltage<span>{{info.voltage}} V</span>
                    </h6>
                    <div class="relative">
                        <p-progressBar [value]="(info.voltage / (info.nominalVoltage + .5)) * 100"
                            [styleClass]="'p-progressbar--thin'">
                            <ng-template pTemplate="content" let-value></ng-template>
                        </p-progressBar>

                        <!-- Conditional marker based on nominal voltage-->
                        <div class="absolute bg-white h-full top-0"
                            [style.left]="(info.nominalVoltage / (info.nominalVoltage + .5)) * 100 + '%'"
                            style="width: 3px;">
                            <small class="absolute text-white white-space-nowrap text-xs"
                                style="bottom: -1rem; transform: translateX(-50%)">
                                {{info.nominalVoltage}} V
                            </small>
                        </div>
                    </div>
                    <strong class="text-red-500" *ngIf="info.voltage < (info.nominalVoltage + .5) * 0.87">
                        Danger: Low Voltage
                    </strong>
                </div>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        ASIC Frequency<span>{{info.frequency}} MHz</span>
                    </h6>
                    <p-progressBar [value]="(info.frequency / maxFrequency) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>

                <div>
                    <h6 class="flex justify-content-between mb-1">
                        Measured ASIC Voltage<span>{{info.coreVoltageActual}} V</span>
                    </h6>
                    <p-progressBar [value]="(info.coreVoltageActual / 1.8) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="text-center">Heat</h4>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        <ng-container *ngIf="info.temp2 > 0; else singleTemp">
                            ASIC Temperature 1
                        </ng-container>
                        <ng-template #singleTemp>
                            ASIC Temperature
                        </ng-template>
                        <span>
                            <ng-container *ngIf="info.temp > 0; else noValue">
                                {{info.temp}} &deg;C
                            </ng-container>
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.temp / maxTemp) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                    <strong class="text-red-500" *ngIf="info.temp >= 70">
                        Danger: High Temperature
                    </strong>
                </div>

                <div class="mb-3" *ngIf="info.temp2 > 0">
                    <h6 class="flex justify-content-between mb-1">
                        ASIC Temperature 2
                        <span>
                            {{info.temp2}} &deg;C
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.temp2 / maxTemp) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                    <strong class="text-red-500" *ngIf="info.temp2 >= 70">
                        Danger: High Temperature
                    </strong>
                </div>

                <div class="mb-3" *ngIf="info.vrTemp > 0">
                    <h6 class="flex justify-content-between mb-1">
                        Voltage Regulator Temperature<span>{{info.vrTemp}} &deg;C</span>
                    </h6>
                    <p-progressBar [value]="(info.vrTemp / 120) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                    <strong class="text-red-500" *ngIf="info.vrTemp >= 105">
                        Danger: High Temperature
                    </strong>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="text-center">Fan</h4>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        Fan Speed<span>{{info.fanspeed.toFixed(1)}} %</span>
                    </h6>
                    <p-progressBar [value]="info.fanspeed" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        <ng-container *ngIf="info.fan2rpm > 0; else singleFan">
                            Fan 1 RPM
                        </ng-container>
                        <ng-template #singleFan>
                            Fan RPM
                        </ng-template>
                        <span>
                            <ng-container *ngIf="info.fanrpm > 0; else noValue">
                                {{info.fanrpm}} RPM
                            </ng-container>
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.fanrpm / maxRpm) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                </div>

                <div *ngIf="info.fan2rpm > 0">
                    <h6 class="flex justify-content-between mb-1">
                        Fan 2 RPM
                        <span>
                            <ng-container *ngIf="info.fan2rpm > 0; else noValue">
                                {{info.fan2rpm}} RPM
                            </ng-container>
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.fan2rpm / maxRpm) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <!-- Slave Mode: Show cluster connection instead of pool -->
                <ng-container *ngIf="isSlaveMode; else poolDisplay">
                    <h4 class="mb-3">
                        <i class="pi pi-sitemap mr-2"></i>Cluster Connection
                    </h4>
                    <ng-container *ngIf="clusterStatus$ | async as clusterStatus">
                        <div class="flex flex-nowrap mb-2">
                            <div class="col-fixed-width text-500">Status</div>
                            <div>
                                <span class="font-medium" [ngClass]="clusterStatus.connectedToMaster ? 'text-green-500' : 'text-red-500'">
                                    <i class="pi mr-1" [ngClass]="clusterStatus.connectedToMaster ? 'pi-check-circle' : 'pi-times-circle'"></i>
                                    {{clusterStatus.connectedToMaster ? 'Connected' : 'Disconnected'}}
                                </span>
                            </div>
                        </div>
                        <div class="flex flex-nowrap mb-2">
                            <div class="col-fixed-width text-500">Transport</div>
                            <div>
                                <i class="pi pi-wifi mr-1 text-blue-500"></i>ESP-NOW
                            </div>
                        </div>
                        <div class="flex flex-nowrap mb-2">
                            <div class="col-fixed-width text-500">Hostname</div>
                            <div>{{clusterStatus.hostname || info.hostname}}</div>
                        </div>
                        <div class="flex flex-nowrap">
                            <div class="col-fixed-width text-500">Role</div>
                            <div>
                                <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 border-round">Slave Node</span>
                            </div>
                        </div>
                    </ng-container>
                </ng-container>

                <!-- Normal Mode: Show pool info -->
                <ng-template #poolDisplay>
                <!-- Dual Pool Mode: Show both pools -->
                <ng-container *ngIf="isDualPoolMode(info); else singlePoolDisplay">
                    <h4 class="mb-3">Pools (Dual Mode)</h4>

                    <!-- Primary Pool -->
                    <div class="mb-3 pb-3 border-bottom-1 border-200">
                        <div class="flex align-items-center gap-2 mb-2">
                            <i class="pi pi-circle-fill text-xs" [ngClass]="{'text-green-500': info.primaryPoolConnected, 'text-red-500': !info.primaryPoolConnected}"></i>
                            <span class="font-medium" [ngClass]="{'text-green-600': info.primaryPoolConnected, 'text-red-600': !info.primaryPoolConnected}">
                                Primary ({{getDualPoolPrimaryPercentage(info)}}%)
                                <span *ngIf="!info.primaryPoolConnected" class="text-xs">(disconnected)</span>
                            </span>
                        </div>
                        <div class="flex flex-nowrap text-sm">
                            <div class="col-fixed-width text-500">URL</div>
                            <div class="text-overflow-ellipsis overflow-hidden">{{ info.stratumURL }}:{{ info.stratumPort }}</div>
                        </div>
                        <div class="flex flex-nowrap text-sm">
                            <div class="col-fixed-width text-500">Diff</div>
                            <div>{{ info.poolDifficulty }}</div>
                        </div>
                        <div class="flex flex-nowrap text-sm">
                            <div class="col-fixed-width text-500">Time</div>
                            <div>{{ info.responseTime }} ms</div>
                        </div>
                    </div>

                    <!-- Secondary Pool -->
                    <div>
                        <div class="flex align-items-center gap-2 mb-2">
                            <i class="pi pi-circle-fill text-xs" [ngClass]="{'text-blue-500': info.secondaryPoolConnected, 'text-red-500': !info.secondaryPoolConnected}"></i>
                            <span class="font-medium" [ngClass]="{'text-blue-600': info.secondaryPoolConnected, 'text-red-600': !info.secondaryPoolConnected}">
                                Secondary ({{getDualPoolSecondaryPercentage(info)}}%)
                                <span *ngIf="!info.secondaryPoolConnected" class="text-xs">(disconnected)</span>
                            </span>
                        </div>
                        <div class="flex flex-nowrap text-sm">
                            <div class="col-fixed-width text-500">URL</div>
                            <div class="text-overflow-ellipsis overflow-hidden">{{ info.fallbackStratumURL }}:{{ info.fallbackStratumPort }}</div>
                        </div>
                        <div class="flex flex-nowrap text-sm">
                            <div class="col-fixed-width text-500">Diff</div>
                            <div>{{ info.poolDifficultySecondary ?? '--' }}</div>
                        </div>
                        <div class="flex flex-nowrap text-sm">
                            <div class="col-fixed-width text-500">Time</div>
                            <div>{{ info.responseTimeSecondary ?? '--' }} ms</div>
                        </div>
                    </div>
                </ng-container>

                <!-- Single Pool / Failover Mode -->
                <ng-template #singlePoolDisplay>
                    <div class="flex flex-nowrap justify-content-between mb-3 relative">
                        <h4 class="mb-0">
                            Pool
                            <a
                                *ngIf="(quickLink$ | async) as quickLink"
                                [href]="quickLink"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="ml-1"
                                [attr.aria-label]="'Open pool dashboard in new tab'"
                                pTooltip="Open pool dashboard"
                                tooltipPosition="top"
                            >
                                <i class="pi pi-external-link"></i>
                            </a>
                        </h4>
                        <p-dropdown
                            [options]="(pools$ | async) ?? []"
                            [(ngModel)]="activePoolLabel"
                            optionLabel="label"
                            optionValue="value"
                            (onChange)="onPoolChange($event)"
                            styleClass="border-100 p-dropdown--small absolute right-0"
                        />
                    </div>

                    <div class="flex flex-nowrap">
                        <div class="col-fixed-width text-500">
                            <tooltip-text-icon
                                text="URL"
                                tooltip="{{ getPoolProtocolType(info) }}"
                            />
                        </div>
                        <div>
                            <span>
                                {{ activePoolURL }}:{{activePoolPort}}
                            </span>
                        </div>
                    </div>

                    <div class="flex flex-nowrap ellipsis-magic overflow-hidden">
                        <div class="col-fixed-width text-500">
                            <tooltip-text-icon
                                text="User"
                                tooltip="{{ activePoolUser }}"
                            />
                        </div>

                        <span class="start" sensitive-data>
                            {{ activePoolUser.substring(0, activePoolUser.length - 20) }}
                        </span>
                        <span class="end" sensitive-data>
                            {{ activePoolUser.substring(activePoolUser.length - 20) }}
                        </span>
                    </div>

                    <div class="flex flex-nowrap">
                        <div class="col-fixed-width text-500">
                            <tooltip-text-icon
                                text="Time"
                                tooltip="Time it takes for the pool to respond to a share"
                            />
                        </div>
                        <div>
                            {{ info.responseTime }} ms
                        </div>
                    </div>

                    <div class="flex flex-nowrap">
                        <div class="col-fixed-width text-500">
                            <span>Difficulty</span>
                        </div>
                        <div>
                            {{ info.poolDifficulty }}
                        </div>
                    </div>
                </ng-template>
                </ng-template>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <!-- Slave Mode: Show local stats instead of block header -->
                <ng-container *ngIf="isSlaveMode; else blockHeaderDisplay">
                    <h4 class="mb-3">
                        <i class="pi pi-chart-bar mr-2"></i>Device Stats
                    </h4>
                    <ng-container *ngIf="clusterStatus$ | async as clusterStatus">
                        <div class="flex flex-nowrap mb-2">
                            <div class="col-fixed-width text-500">Hashrate</div>
                            <div class="text-theme font-medium">{{info.hashRate | hashSuffix}}</div>
                        </div>
                        <div class="flex flex-nowrap mb-2">
                            <div class="col-fixed-width text-500">Temperature</div>
                            <div>{{info.temp | number:'1.1-1'}} &deg;C</div>
                        </div>
                        <div class="flex flex-nowrap mb-2">
                            <div class="col-fixed-width text-500">Power</div>
                            <div>{{info.power | number:'1.1-1'}} W</div>
                        </div>
                        <div class="flex flex-nowrap">
                            <div class="col-fixed-width text-500">Frequency</div>
                            <div>{{info.frequency}} MHz</div>
                        </div>
                    </ng-container>
                </ng-container>

                <!-- Normal Mode: Show block header -->
                <ng-template #blockHeaderDisplay>
                <!-- Dual Pool Mode: Show both pools' block headers -->
                <ng-container *ngIf="isDualPoolMode(info); else singleBlockHeader">
                    <h4 class="mb-3">Block Headers (Dual Mode)</h4>

                    <!-- Primary Pool Block Header -->
                    <div class="mb-3 pb-3 border-bottom-1 border-200">
                        <div class="flex align-items-center gap-2 mb-2">
                            <i class="pi pi-circle-fill text-xs" [ngClass]="{'text-green-500': info.primaryPoolConnected, 'text-red-500': !info.primaryPoolConnected}"></i>
                            <span class="font-medium" [ngClass]="{'text-green-600': info.primaryPoolConnected, 'text-red-600': !info.primaryPoolConnected}">Primary</span>
                        </div>
                        <div class="flex flex-nowrap text-sm">
                            <div class="col-fixed-width text-500">Height</div>
                            <div>{{ info.blockHeight ?? '--' }}</div>
                        </div>
                        <div class="flex flex-nowrap text-sm">
                            <div class="col-fixed-width text-500">Difficulty</div>
                            <div>{{ info.networkDifficulty ? (info.networkDifficulty | diffSuffix) : '--' }}</div>
                        </div>
                        <div class="flex flex-nowrap align-items-baseline text-sm">
                            <div class="col-fixed-width text-500">Scriptsig</div>
                            <div class="code text-overflow-ellipsis overflow-hidden">{{ info.scriptsig ?? '--' }}</div>
                        </div>
                    </div>

                    <!-- Secondary Pool Block Header -->
                    <div>
                        <div class="flex align-items-center gap-2 mb-2">
                            <i class="pi pi-circle-fill text-xs" [ngClass]="{'text-blue-500': info.secondaryPoolConnected, 'text-red-500': !info.secondaryPoolConnected}"></i>
                            <span class="font-medium" [ngClass]="{'text-blue-600': info.secondaryPoolConnected, 'text-red-600': !info.secondaryPoolConnected}">Secondary</span>
                        </div>
                        <div class="flex flex-nowrap text-sm">
                            <div class="col-fixed-width text-500">Height</div>
                            <div>{{ info.blockHeightSecondary ?? '--' }}</div>
                        </div>
                        <div class="flex flex-nowrap text-sm">
                            <div class="col-fixed-width text-500">Difficulty</div>
                            <div>{{ info.networkDifficultySecondary ? (info.networkDifficultySecondary | diffSuffix) : '--' }}</div>
                        </div>
                        <div class="flex flex-nowrap align-items-baseline text-sm">
                            <div class="col-fixed-width text-500">Scriptsig</div>
                            <div class="code text-overflow-ellipsis overflow-hidden">{{ info.scriptsigSecondary ?? '--' }}</div>
                        </div>
                    </div>
                </ng-container>

                <!-- Single Pool / Failover Mode -->
                <ng-template #singleBlockHeader>
                    <h4 class="white-space-nowrap overflow-hidden text-overflow-ellipsis">Block Header</h4>

                    <div class="flex flex-nowrap">
                        <div class="col-fixed-width text-500">
                            <span>Height</span>
                        </div>
                        <div>
                            {{ info.blockHeight }}
                        </div>
                    </div>

                    <div class="flex flex-nowrap">
                        <div class="col-fixed-width text-500">
                            <span>Difficulty</span>
                        </div>
                        <div *ngIf="info.networkDifficulty" class="cursor-pointer" pTooltip="{{info.networkDifficulty | number:'1.0-0'}}" tooltipPosition="bottom">
                            {{ info.networkDifficulty | diffSuffix }}
                        </div>
                    </div>

                    <div class="flex flex-nowrap align-items-baseline">
                        <div class="col-fixed-width text-500">
                            <span>Scriptsig</span>
                        </div>
                        <div class="code">
                            {{ info.scriptsig }}
                        </div>
                    </div>
                </ng-template>
                </ng-template>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="white-space-nowrap overflow-hidden text-overflow-ellipsis">Hashrate Registers</h4>

                <ng-container *ngIf="getAsicsAmount(info) as asicAmount">
                    <table class="heatmap text-{{asicAmount <= 2 ? 'sm' : 'xs'}}">
                        <thead>
                            <tr>
                                <th *ngIf="asicAmount > 1" class="text-left">ASIC</th>
                                <ng-container *ngIf="getAsicDomainsAmount(info) as asicDomainsAmount">
                                    <th *ngIf="asicDomainsAmount > 0" [attr.colspan]="asicDomainsAmount">
                                        {{ asicDomainsAmount == 1 ? "Domain" : "Domains" }}
                                    </th>
                                </ng-container>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="cursor-pointer" *ngFor="let asic of info.hashrateMonitor.asics; let i = index"
                                    [pTooltip]="(asicAmount > 1 ? 'ASIC ' + (i + 1) + ' - ' : '') + 'Error count: ' + asic.errorCount"
                                    tooltipPosition="bottom">
                                <td *ngIf="asicAmount > 1" class="text-500 text-left">
                                    {{ i + 1 }}
                                </td>
                                <td *ngFor="let domain of asic.domains"
                                    [style.background]="getHeatmapColor(info, domain)"
                                    [style.height]="(asicAmount <= 2 ? '2rem' : null)"
                                    class="text-center">
                                    <span class="text-xs">{{ domain | hashSuffix }}</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </ng-container>
            </div>
        </div>
    </div>

    <!-- Connected Slaves List (Master Mode Only) -->
    <ng-container *ngIf="clusterStatus$ | async as clusterStatus">
        <div class="card mt-3" *ngIf="clusterStatus.mode === 1 && clusterStatus.slaves && clusterStatus.slaves.length > 0">
            <div class="flex justify-content-between align-items-center mb-3">
                <h4 class="m-0">
                    <i class="pi pi-users mr-2"></i>
                    Connected Slaves ({{clusterStatus.slaves.length}})
                </h4>
                <a routerLink="/cluster" class="text-primary text-sm cursor-pointer">
                    <i class="pi pi-cog mr-1"></i>Manage
                </a>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-500 text-sm">
                            <th class="text-left p-2">Device</th>
                            <th class="text-center p-2">Hashrate</th>
                            <th class="text-center p-2">Temp</th>
                            <th class="text-center p-2">Power</th>
                            <th class="text-center p-2">Shares</th>
                            <th class="text-center p-2">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let slave of clusterStatus.slaves" class="border-top-1 surface-border">
                            <td class="p-2">
                                <div class="flex align-items-center gap-2">
                                    <i class="pi {{getSlaveStateIcon(slave.state)}}"
                                       [ngClass]="clusterService.getSlaveStateClass(slave.state)"></i>
                                    <div>
                                        <div class="font-medium">{{slave.hostname}}</div>
                                        <a *ngIf="slave.ipAddr"
                                           [href]="'http://' + slave.ipAddr"
                                           target="_blank"
                                           class="text-primary text-xs no-underline hover:underline"
                                           (click)="$event.stopPropagation()">{{slave.ipAddr}}</a>
                                        <span *ngIf="!slave.ipAddr" class="text-500 text-xs">ESP-NOW</span>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center p-2">
                                <span class="text-theme font-medium">{{formatClusterHashrate(slave.hashrate)}}</span>
                            </td>
                            <td class="text-center p-2">
                                <span [ngClass]="{'text-red-500': slave.temperature >= 70}">
                                    {{slave.temperature | number:'1.1-1'}}&deg;C
                                </span>
                            </td>
                            <td class="text-center p-2">
                                {{slave.power | number:'1.1-1'}} W
                            </td>
                            <td class="text-center p-2">
                                <span class="text-theme">{{slave.sharesAccepted}}</span>
                                <span class="text-400">/</span>
                                <span class="text-red-500">{{slave.sharesSubmitted - slave.sharesAccepted}}</span>
                            </td>
                            <td class="text-center p-2">
                                <span class="text-xs px-2 py-1 border-round"
                                      [ngClass]="clusterService.getSlaveStateClass(slave.state)">
                                    {{clusterService.getSlaveStateLabel(slave.state)}}
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No slaves connected message -->
        <div class="card mt-3" *ngIf="clusterStatus.mode === 1 && (!clusterStatus.slaves || clusterStatus.slaves.length === 0)">
            <div class="text-center py-4">
                <i class="pi pi-users text-3xl text-500 mb-2"></i>
                <p class="text-500 m-0">No slaves connected</p>
                <p class="text-400 text-sm mt-1">Waiting for slave devices to register via ESP-NOW...</p>
            </div>
        </div>
    </ng-container>

    <app-confetti *ngIf="info.blockFound"></app-confetti>
</ng-container>
